<!DOCTYPE html>
<html>
<head>
  <title>ClickFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self';">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
      /* é˜²æ­¢æ‰‹æ©Ÿé€£é»æ”¾å¤§ */
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      /* é˜²æ­¢æ‰‹æ©Ÿç‰ˆä¸‹æ‹‰åˆ·æ–° */
      overscroll-behavior-y: none;
      -webkit-overflow-scrolling: touch;
    }

    html {
      /* é˜²æ­¢æ‰‹æ©Ÿç‰ˆä¸‹æ‹‰åˆ·æ–° */
      overscroll-behavior-y: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .user-info {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* æˆå°±å¾½ç« å®¹å™¨æ¨£å¼ï¼ˆæ¨™é¡Œè¦–çª—ï¼‰ */
    .badges-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* æˆå°±å¾½ç« å®¹å™¨æ¨£å¼ï¼ˆéŠæˆ²ä¸»è¦–çª—å³ä¸Šè§’ï¼‰ */
    .badges-container-game {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
      z-index: 10;
    }

    .badges-label {
      font-size: 11px;
      color: #666;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .badges-slots-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .badge-slot {
      width: 50px;
      height: 50px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .badge-slot:hover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.05);
    }

    .badge-slot.has-badge {
      border: 2px solid #667eea;
      background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
    }

    .badge-icon {
      font-size: 28px;
      line-height: 1;
    }

    .badge-slot:not(.has-badge) .badge-icon {
      color: #999;
      font-size: 20px;
    }

    .username-display {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      padding: 8px 16px;
      background: #f0f4ff;
      border-radius: 8px;
      border: 2px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }

    .username-display:hover {
      background: #667eea;
      color: white;
      transform: scale(1.05);
    }

    .settings-container {
      position: relative;
      margin-left: 10px;
    }

    .settings-btn {
      font-size: 14px;
      font-weight: bold;
      color: #667eea;
      padding: 6px 12px;
      background: #fff;
      border-radius: 6px;
      border: 2px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .settings-btn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.05);
    }

    .settings-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 5px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 150px;
      z-index: 1000;
      overflow: hidden;
    }

    .settings-dropdown.active {
      display: block;
    }

    .settings-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
      font-size: 14px;
    }

    .settings-dropdown-item:last-child {
      border-bottom: none;
    }

    .settings-dropdown-item:hover {
      background: #f5f5f5;
    }

    .settings-dropdown-item.logout {
      color: #dc3545;
    }

    .settings-dropdown-item.logout:hover {
      background: #fee;
      color: #c82333;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }

    .stat-item strong {
      color: #667eea;
    }

    .coins {
      font-size: 24px;
      font-weight: bold;
      color: #f59e0b;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .panel h2 {
      margin-bottom: 15px;
      color: #667eea;
      font-size: 20px;
    }

    .game-area {
      grid-column: 1 / -1;
    }

    .login-panel {
      text-align: center;
      padding: 40px;
    }

    .login-panel input {
      padding: 12px;
      font-size: 16px;
      border: 2px solid #667eea;
      border-radius: 5px;
      margin-right: 10px;
      width: 200px;
      /* å…è¨±è¼¸å…¥æ¡†é¸æ“‡æ–‡å­— */
      user-select: text;
      -webkit-user-select: text;
    }

    .login-panel button {
      padding: 12px 24px;
      font-size: 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-panel button:hover {
      background: #5568d3;
    }

    .game-container {
      position: relative;
      text-align: center;
      min-height: 400px;
    }

    .timer {
      font-size: 32px;
      font-weight: normal;
      color: #999999;
      margin: 15px 0;
    }

    .click-buttons-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: 20px 0;
    }

    /* ä¸»æŒ‰éˆ•å®¹å™¨ */
    .main-button-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
    }

    /* è‡ªå‹•é»æ“ŠæŒ‰éˆ•å®¹å™¨ */
    .auto-click-buttons-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      width: 100%;
    }

    .click-button {
      padding: 30px 50px;
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4),
                  0 4px 8px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
      min-width: 150px;
      user-select: none;
      position: relative;
      overflow: visible;
      /* é˜²æ­¢æ‰‹æ©Ÿé€£é»æ”¾å¤§ */
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .click-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .click-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5),
                  0 6px 12px rgba(0, 0, 0, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .click-button:hover::before {
      left: 100%;
    }

    .click-button:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3),
                  0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* é»æ“Šæ™‚æ–‡å­—ä¸‹æ²‰ä¸Šæµ®æ•ˆæœï¼ˆåªæ‡‰ç”¨æ–¼æŒ‰éˆ•å…§çš„æ–‡å­—ï¼Œä¸å½±éŸ¿æŒ‰éˆ•æœ¬èº«ï¼‰ */
    .click-button.click-text-animation .button-text {
      animation: textBounce 0.4s ease-out;
    }

    @keyframes textBounce {
      0% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(8px);
      }
      100% {
        transform: translateY(0);
      }
    }

    /* æ»‘é¼ æ¸¸æ¨™åœ–æ¨™ */
    .click-button::after {
      content: 'ğŸ–±ï¸';
      position: absolute;
      bottom: 5px;
      right: 5px;
      font-size: 16px;
      opacity: 0.6;
      transition: all 0.3s;
      pointer-events: none;
    }

    .click-button:hover::after {
      opacity: 1;
      transform: scale(1.2);
    }

    .click-button:active::after {
      transform: scale(0.9) translateY(2px);
    }

    .click-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* è‡ªå‹•é»æ“ŠæŒ‰éˆ•ç¦ç”¨æ¨£å¼ */
    .click-button.auto-click-button:disabled {
      opacity: 0.8;
      cursor: default;
    }

    /* è‡ªå‹•é»æ“ŠæŒ‰éˆ•ç¸®å°æ¨£å¼ */
    .click-button.auto-click-button {
      padding: 15px 25px;
      font-size: 18px;
      min-width: 120px;
      transform: scale(0.85);
    }

    .click-button.auto-click-button::after {
      font-size: 14px;
      bottom: 3px;
      right: 3px;
    }

    /* è‡ªå‹•é»æ“Šç‰¹æ•ˆ */
    .click-button.auto-click-animation {
      animation: autoClickPulse 0.4s ease-in-out;
      animation-fill-mode: none;
    }

    /* è‡ªå‹•é»æ“Šæ–‡å­—æŠ–å‹•æ•ˆæœ */
    .click-button.auto-click-animation .button-text {
      animation: autoClickTextShake 0.4s ease-in-out;
      animation-fill-mode: none;
    }

    @keyframes autoClickTextShake {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      10% {
        transform: translateY(-3px) rotate(-1deg);
      }
      20% {
        transform: translateY(3px) rotate(1deg);
      }
      30% {
        transform: translateY(-4px) rotate(-1.5deg);
      }
      40% {
        transform: translateY(4px) rotate(1.5deg);
      }
      50% {
        transform: translateY(-5px) rotate(-2deg);
      }
      60% {
        transform: translateY(5px) rotate(2deg);
      }
      70% {
        transform: translateY(-4px) rotate(-1.5deg);
      }
      80% {
        transform: translateY(3px) rotate(1deg);
      }
      90% {
        transform: translateY(-2px) rotate(-0.5deg);
      }
    }

    @keyframes autoClickPulse {
      0% {
        transform: scale(1);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4),
                    0 4px 8px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      30% {
        transform: scale(0.75);
        box-shadow: 0 0 30px rgba(102, 126, 234, 0.9),
                    0 0 60px rgba(118, 75, 162, 0.6),
                    0 4px 12px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #7c8ef5 0%, #8a5fb8 100%);
      }
      60% {
        transform: scale(1.1);
        box-shadow: 0 0 40px rgba(102, 126, 234, 1),
                    0 0 80px rgba(118, 75, 162, 0.8),
                    0 8px 24px rgba(0, 0, 0, 0.15);
        background: linear-gradient(135deg, #8a9ef8 0%, #9a6fc4 100%);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4),
                    0 4px 8px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
    }

    /* è‡ªå‹•é»æ“ŠæŒ‰éˆ•çš„æ©Ÿå™¨äººåœ–æ¨™ */
    .click-button.auto-click-button::after {
      content: 'ğŸ¤–';
    }

    .clicks-display {
      font-size: 64px;
      font-weight: bold;
      color: #28a745;
      margin: 25px 0;
      text-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      letter-spacing: 1px;
    }

    .game-controls {
      margin: 20px 0;
    }

    .btn {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4),
                  0 2px 5px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #ff5722 0%, #ff8c00 100%);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6),
                  0 4px 10px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(255, 107, 53, 0.4),
                  0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    /* å•†åº—å’Œæˆå°±æŒ‰éˆ•æ¨£å¼ - ä½¿ç”¨è—è‰²ç³»ä»¥æå‡ emoji å¯è¦‹åº¦ */
    .btn-shop {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4),
                  0 2px 5px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .btn-shop:hover {
      background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6),
                  0 4px 10px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .btn-shop:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4),
                  0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .btn-achievement {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4),
                  0 2px 5px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .btn-achievement:hover {
      background: linear-gradient(135deg, #e081f0 0%, #e0455a 100%);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6),
                  0 4px 10px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .btn-achievement:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(245, 87, 108, 0.4),
                  0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .shop-items {
      display: grid;
      gap: 15px;
    }

    .shop-item {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      transition: border-color 0.3s;
    }

    .shop-item:hover {
      border-color: #667eea;
    }

    .shop-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-weight: bold;
      font-size: 18px;
    }

    .shop-item-level {
      background: #667eea;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
    }

    .shop-item-description {
      color: #666;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .shop-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shop-item-price {
      font-weight: bold;
      color: #f59e0b;
      font-size: 18px;
    }

    .shop-item.disabled {
      opacity: 0.5;
      background: #f5f5f5;
      border-color: #ccc;
    }

    .shop-item.disabled:hover {
      border-color: #ccc;
    }

    .shop-item.disabled .shop-item-name {
      color: #999;
    }

    .shop-item.disabled .shop-item-level {
      background: #999;
    }

    .shop-item.disabled .shop-item-description {
      color: #999;
    }

    .shop-item.disabled .shop-item-price {
      color: #999;
    }

    .shop-item-requirement {
      color: #dc3545;
      font-size: 12px;
      margin-top: 8px;
      font-weight: bold;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .achievement-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s;
    }

    .achievement-card.unlocked {
      border-color: #28a745;
      background: #f0fff4;
    }

    .achievement-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .achievement-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 12px;
      color: #666;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* è¼‰å…¥ä¸­æ¨¡æ…‹æ¡†æ¨£å¼ */
    .loading-modal .modal-content {
      text-align: center;
      padding: 40px;
      max-width: 300px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #667eea;
      margin-top: 10px;
    }

    .loading-details {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
      line-height: 1.5;
    }

    /* è³¼è²·æˆåŠŸé€šçŸ¥ Toast */
    .purchase-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(500px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
    }

    /* éŒ¯èª¤æç¤º Toast */
    .error-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(245, 101, 101, 0.4);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(500px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
    }

    .error-toast.show {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }

    .error-toast-icon {
      font-size: 32px;
      line-height: 1;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      25% {
        transform: translateX(-5px);
      }
      75% {
        transform: translateX(5px);
      }
    }

    .error-toast-content {
      flex: 1;
    }

    .error-toast-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .error-toast-message {
      font-size: 14px;
      opacity: 0.95;
      line-height: 1.5;
    }

    .error-toast-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .error-toast-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    @media (max-width: 768px) {
      .error-toast {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        max-width: none;
      }
    }

    /* éŠæˆ²çµç®— Toast */
    .game-result-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(72, 187, 120, 0.4);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(500px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
    }

    .game-result-toast.show {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }

    .game-result-toast-icon {
      font-size: 32px;
      line-height: 1;
      animation: bounce 0.6s ease-in-out;
    }

    .game-result-toast-content {
      flex: 1;
    }

    .game-result-toast-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .game-result-toast-message {
      font-size: 14px;
      opacity: 0.95;
      line-height: 1.8;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .result-label {
      opacity: 0.9;
    }

    .result-value {
      font-weight: bold;
      font-size: 16px;
    }

    .result-value.coins-value {
      color: #ffd700;
      font-size: 18px;
    }

    .result-loading {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .game-result-toast-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .game-result-toast-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    @media (max-width: 768px) {
      .game-result-toast {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        max-width: none;
      }
    }

    .purchase-toast.show {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }

    .purchase-toast-icon {
      font-size: 32px;
      line-height: 1;
      animation: bounce 0.6s ease-in-out;
    }

    @keyframes bounce {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
    }

    .purchase-toast-content {
      flex: 1;
    }

    .purchase-toast-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .purchase-toast-message {
      font-size: 14px;
      opacity: 0.95;
    }

    .purchase-toast-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .purchase-toast-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    @media (max-width: 768px) {
      .purchase-toast {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        max-width: none;
      }
    }

    /* æ­·å²è¨˜éŒ„æ¨¡æ…‹æ¡†ä½¿ç”¨æ›´å¤§çš„å¯¬åº¦ */
    #historyModal .modal-content {
      max-width: 750px;
    }

    /* å¾½ç« é¸æ“‡æ¨¡æ…‹æ¡†ç‰¹å®šæ¨£å¼ - å¢åŠ å¯¬åº¦å’Œé«˜åº¦ */
    .badge-select-modal-content {
      max-width: 800px;
      width: 85%;
      max-height: 85vh;
    }

    /* ç¾åŒ–ç¢ºèªå°è©±æ¡†æ¨£å¼ */
    .confirm-modal-content {
      text-align: center;
      max-width: 400px;
      padding: 40px 30px;
    }

    .confirm-icon {
      font-size: 64px;
      margin-bottom: 20px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .confirm-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    .confirm-message {
      font-size: 16px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .confirm-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
      color: #4a5568;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ç¾åŒ–æç¤ºå°è©±æ¡†æ¨£å¼ */
    .alert-modal-content {
      text-align: center;
      max-width: 400px;
      padding: 40px 30px;
    }

    .alert-icon {
      font-size: 64px;
      margin-bottom: 20px;
      animation: bounce 0.6s ease-in-out;
    }

    .alert-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    .alert-message {
      font-size: 16px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .alert-buttons {
      display: flex;
      justify-content: center;
    }

    /* ç¾åŒ–æˆå°±è§£é–é€šçŸ¥ */
    #achievementNotification .modal-content {
      text-align: center;
      max-width: 450px;
      padding: 40px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
    }

    .achievement-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.8s ease-in-out;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
    }

    #achievementNotification h2 {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 15px;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #achievementNotification p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 30px;
      opacity: 0.95;
    }

    #achievementNotification .btn-primary {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.5);
      color: white;
      padding: 12px 40px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    #achievementNotification .btn-primary:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.7);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .auto-clicker-info {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }

    /* è¶…ç´šå¸³è™Ÿæ™‚é–“èª¿æ•´æ¬„ä½ */
    .super-account-controls {
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid #d0d0d0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 80%;
      max-width: 800px;
    }

    .super-account-controls .controls-row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .super-account-controls .controls-row > div {
      flex: 1;
      min-width: 0;
    }

    .super-account-controls h3 {
      margin: 0 0 10px 0;
      color: #666666;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .super-account-controls .time-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .super-account-controls .time-control-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .super-account-controls label {
      font-weight: bold;
      color: #555555;
      font-size: 14px;
      margin: 0;
    }

    .super-account-controls .range-container {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .super-account-controls .range-label {
      font-size: 12px;
      color: #666666;
      font-weight: bold;
      white-space: nowrap;
      min-width: 40px;
    }

    .super-account-controls input[type="range"] {
      flex: 1;
      height: 4px;
      border-radius: 2px;
      background: white;
      outline: none;
      -webkit-appearance: none;
      margin: 0;
    }

    .super-account-controls input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #888888;
      cursor: pointer;
      border: 2px solid #aaaaaa;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transition: all 0.3s;
    }

    .super-account-controls input[type="range"]::-webkit-slider-thumb:hover {
      background: #666666;
      transform: scale(1.1);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }

    .super-account-controls input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #888888;
      cursor: pointer;
      border: 2px solid #aaaaaa;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transition: all 0.3s;
    }

    .super-account-controls input[type="range"]::-moz-range-thumb:hover {
      background: #666666;
      transform: scale(1.1);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }

    .super-account-controls .time-value-display {
      font-size: 16px;
      font-weight: bold;
      color: #555555;
      margin: 0;
      white-space: nowrap;
    }

    .super-account-controls .shop-rollback-control {
      padding-left: 20px;
      border-left: 2px solid #d0d0d0;
    }

    .super-account-controls .time-control h4,
    .super-account-controls .shop-rollback-control h4 {
      margin: 0 0 15px 0;
      color: #666666;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .super-account-controls .shop-item-select {
      margin-bottom: 15px;
    }

    .super-account-controls .shop-item-select label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555555;
      font-size: 14px;
    }

    .super-account-controls .shop-item-select select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #d0d0d0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #333;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .super-account-controls .shop-item-select select:hover {
      border-color: #667eea;
    }

    .super-account-controls .shop-item-select select:focus {
      outline: none;
      border-color: #667eea;
    }

    .super-account-controls .level-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .super-account-controls .level-control-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .super-account-controls .level-value-display {
      font-size: 14px;
      font-weight: bold;
      color: #667eea;
      background: white;
      padding: 4px 12px;
      border-radius: 6px;
      border: 1px solid #667eea;
      min-width: 60px;
      text-align: center;
    }

    .super-account-controls .rollback-button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .super-account-controls .rollback-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .super-account-controls .rollback-button:active {
      transform: translateY(0);
    }

    .super-account-controls .rollback-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .super-account-controls .current-level-info {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
      text-align: center;
    }

    @media (max-width: 768px) {
      body {
        padding: 8px;
      }

      .container {
        max-width: 100%;
      }

      .main-content {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 12px;
      }

      .header {
        flex-direction: column;
        text-align: center;
        padding: 12px;
        gap: 8px;
        margin-bottom: 12px;
        border-radius: 8px;
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .user-info {
        flex-direction: row;
        flex-wrap: wrap;
        width: 100%;
        gap: 8px;
        justify-content: center;
        align-items: center;
      }

      .stat-item {
        font-size: 13px;
        gap: 4px;
        padding: 4px 8px;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .coins {
        font-size: 18px;
      }

      .panel {
        padding: 12px;
        border-radius: 8px;
      }

      .panel h2 {
        font-size: 18px;
        margin-bottom: 10px;
      }

      .game-container {
        min-height: auto;
        padding: 8px;
        position: relative;
      }

      .badges-container-game {
        top: 8px;
        right: 8px;
        gap: 4px;
      }

      .badges-label {
        font-size: 10px;
        padding: 2px 6px;
      }

      .badge-slot {
        width: 36px;
        height: 36px;
        border-radius: 6px;
      }

      .badge-icon {
        font-size: 20px;
      }

      .game-container h2 {
        font-size: 18px;
        margin: 8px 0 12px 0;
      }

      .super-account-controls {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
      }

      .super-account-controls .controls-row {
        flex-direction: column;
        gap: 12px;
      }

      .super-account-controls .shop-rollback-control {
        padding-left: 0;
        border-left: none;
        padding-top: 12px;
        border-top: 2px solid #d0d0d0;
      }

      .username-display {
        margin-right: 0;
        margin-bottom: 0;
        font-size: 14px;
        padding: 5px 10px;
      }

      .settings-container {
        margin-left: 0;
        margin-top: 0;
      }

      .settings-btn {
        font-size: 13px;
        padding: 5px 10px;
      }

      .settings-dropdown {
        right: 0;
        left: auto;
        min-width: 120px;
        max-width: calc(100vw - 60px);
        white-space: nowrap;
      }

      .click-button {
        padding: 40px 30px;
        font-size: 20px;
        min-width: 100%;
        width: 100%;
        max-width: 100%;
        /* æ‰‹æ©Ÿä¸Šæ›´å¤§çš„è§¸æ§å€åŸŸ */
        min-height: 80px;
        border-radius: 16px;
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4),
                    0 3px 6px rgba(0, 0, 0, 0.1);
      }

      .click-button.auto-click-button {
        padding: 18px 20px;
        font-size: 14px;
        min-width: calc(50% - 4px);
        min-height: 55px;
        border-radius: 12px;
      }

      .click-buttons-container {
        gap: 12px;
        margin: 12px 0;
        padding: 0 4px;
      }

      .auto-click-buttons-wrapper {
        gap: 8px;
        width: 100%;
        justify-content: space-between;
      }

      .timer {
        font-size: 32px;
        margin: 45px 0 10px 0;
        font-weight: bold;
        color: #667eea;
      }

      .clicks-display {
        font-size: 48px;
        margin: 15px 0;
        line-height: 1.2;
      }

      .game-controls {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
        margin: 0;
        flex: 1;
        min-width: calc(33.333% - 4px);
        max-width: calc(33.333% - 4px);
        border-radius: 8px;
      }

      .auto-clicker-info {
        font-size: 12px;
        padding: 8px;
        margin: 8px 0;
        border-radius: 6px;
        text-align: center;
      }

      .modal-content {
        padding: 16px;
        width: 95%;
        max-height: 85vh;
        border-radius: 12px;
      }

      .modal-header {
        margin-bottom: 15px;
      }

      .modal-header h2 {
        font-size: 18px;
      }

      .shop-item {
        padding: 12px;
        border-radius: 8px;
      }

      .shop-item-name {
        font-size: 16px;
      }

      .achievements-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
      }

      .achievement-icon {
        font-size: 32px;
      }

      .login-panel {
        padding: 25px 15px;
      }

      .login-panel h2 {
        font-size: 20px;
        margin-bottom: 15px;
      }

      .login-panel input {
        width: 100%;
        max-width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
        padding: 14px;
        font-size: 16px;
        /* å…è¨±è¼¸å…¥æ¡†é¸æ“‡æ–‡å­— */
        user-select: text;
        -webkit-user-select: text;
      }

      .login-panel button {
        width: 100%;
        max-width: 100%;
        padding: 14px;
        font-size: 16px;
      }

      /* æ­·å²è¨˜éŒ„é¢æ¿å„ªåŒ– */
      .panel:has(#historyContainer) {
        padding: 10px;
      }

      #historyContainer table {
        font-size: 12px;
      }

      #historyContainer th,
      #historyContainer td {
        padding: 6px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ClickFast âš¡</h1>
      <div class="user-info" id="userInfo" style="display: none;">
        <div class="stat-item">
          <span>ğŸ’°</span>
          <span class="coins" id="coinsDisplay">0</span>
        </div>
        <div class="stat-item">
          <strong>ç¸½é»æ“Š:</strong> <span id="totalClicksDisplay">0</span>
        </div>
        <div class="stat-item">
          <strong>æœ€ä½³:</strong> <span id="bestClicksDisplay">0</span>
        </div>
        <div class="stat-item">
          <strong>éŠæˆ²æ•¸:</strong> <span id="gamesPlayedDisplay">0</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
          <div class="username-display" id="usernameDisplay" onclick="openAccount()">ID: å¸³è™Ÿåç¨±</div>
          <div class="settings-container">
            <button class="settings-btn" onclick="toggleSettings()">
              âš™ï¸ è¨­å®š
            </button>
            <div class="settings-dropdown" id="settingsDropdown">
              <div class="settings-dropdown-item" onclick="openHistory(); closeSettings();">ğŸ“Š æ­·å²è¨˜éŒ„</div>
              <div class="settings-dropdown-item logout" onclick="logoutUser(); closeSettings();">ğŸšª ç™»å‡º</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="loginPanel" class="panel login-panel">
      <h2>æ­¡è¿ä¾†åˆ° ClickFastï¼</h2>
      <p style="margin: 20px 0;">è«‹è¼¸å…¥ç”¨æˆ¶åé–‹å§‹éŠæˆ²</p>
      <div>
        <input type="text" id="usernameInput" placeholder="è¼¸å…¥ç”¨æˆ¶å" maxlength="20">
        <button onclick="loginOrRegister()">é–‹å§‹éŠæˆ²</button>
      </div>
    </div>

    <div id="gameContent" style="display: none;">
      <div class="main-content">
        <div class="panel game-area">
          <div class="game-container">
            <!-- æˆå°±å¾½ç« é¡¯ç¤ºå€åŸŸï¼ˆå³ä¸Šè§’ï¼‰ -->
            <div class="badges-container-game">
              <div class="badges-label" title="é»æ“Šä¸‹æ–¹å¾½ç« æ§½ä½å¯é¸æ“‡è¦é¡¯ç¤ºçš„æˆå°±å¾½ç« ">ğŸ… å¾½ç« ç³»çµ±</div>
              <div class="badges-slots-container">
                <div class="badge-slot" id="badgeSlot1" onclick="selectBadge(1)" title="é»æ“Šé¸æ“‡å¾½ç« ">
                  <span class="badge-icon" id="badgeIcon1">-</span>
                </div>
                <div class="badge-slot" id="badgeSlot2" onclick="selectBadge(2)" title="é»æ“Šé¸æ“‡å¾½ç« ">
                  <span class="badge-icon" id="badgeIcon2">-</span>
                </div>
                <div class="badge-slot" id="badgeSlot3" onclick="selectBadge(3)" title="é»æ“Šé¸æ“‡å¾½ç« ">
                  <span class="badge-icon" id="badgeIcon3">-</span>
                </div>
              </div>
            </div>
            <h2>é»æ“ŠéŠæˆ²</h2>
            <!-- è¶…ç´šå¸³è™Ÿæ™‚é–“èª¿æ•´æ¬„ä½ -->
            <div class="super-account-controls" id="superAccountControls" style="display: none;">
              <h3>ğŸ‘‘ è¶…ç´šå¸³è™Ÿæ§åˆ¶é¢æ¿</h3>
              <div class="controls-row">
                <div class="time-control">
                  <h4>â±ï¸ éŠæˆ²æ™‚é•·</h4>
                  <div class="time-control-header">
                    <label for="superTimeInput">éŠæˆ²æ™‚é•·ï¼š</label>
                    <div class="time-value-display" id="superTimeDisplay">5 ç§’</div>
                  </div>
                  <div class="range-container">
                    <span class="range-label">5(ç§’)</span>
                    <input type="range" id="superTimeInput" min="5" max="30" step="1" value="5">
                    <span class="range-label">30(ç§’)</span>
                  </div>
                </div>
                <!-- å•†åº—ç­‰ç´šå›æº¯æ§åˆ¶ -->
                <div class="shop-rollback-control">
                  <h4>ğŸ”„ å•†åº—ç­‰ç´šå›æº¯</h4>
                  <p style="font-size: 12px; color: #888; margin-bottom: 15px; text-align: center;">
                    å°‡æ‰€æœ‰å•†åº—ç‰©å“å›æº¯åˆ°åˆå§‹ç‹€æ…‹ï¼ˆç­‰ç´š 0ï¼‰
                  </p>
                  <button class="rollback-button" id="rollbackAllButton" onclick="rollbackAllShopItems()">
                    ğŸ”„ å…¨éƒ¨å›æº¯
                  </button>
                </div>
              </div>
            </div>
            <div class="timer" id="timerDisplay">5.0 ç§’</div>
            <div class="clicks-display" id="clicksDisplay">0 æ¬¡é»æ“Š</div>
            <div class="game-controls">
              <button class="btn btn-primary" id="startButton" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
              <button class="btn btn-shop" onclick="openShop()">ğŸ›’ å•†åº—</button>
              <button class="btn btn-achievement" onclick="openAchievements()">ğŸ† æˆå°±</button>
            </div>
            <div class="click-buttons-container" id="clickButtonsContainer">
              <button class="click-button" id="mainClickButton" onclick="handleClick()" disabled>
                <span class="button-text">é»æ“Šï¼</span>
              </button>
            </div>
            <div class="auto-clicker-info" id="autoClickerInfo" style="display: none;">
              ğŸ¤– è‡ªå‹•é»æ“Šå™¨: <span id="autoClickerRatePerButton">0</span> æ¬¡/ç§’ Ã— <span id="autoClickerCount">0</span> å€‹ = <span id="autoClickerTotalRate">0</span> æ¬¡/ç§’
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>æœ€è¿‘è¨˜éŒ„</h2>
          <div id="historyContainer">
            <p style="color: #666;">æš«ç„¡è¨˜éŒ„</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å•†åº—æ¨¡æ…‹æ¡† -->
  <div class="modal" id="shopModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>å•†åº— ğŸ›’</h2>
        <button class="close-btn" onclick="closeShop()">&times;</button>
      </div>
      <div id="shopItemsContainer"></div>
    </div>
  </div>

  <!-- æˆå°±æ¨¡æ…‹æ¡† -->
  <div class="modal" id="achievementsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>æˆå°± ğŸ†</h2>
        <button class="close-btn" onclick="closeAchievements()">&times;</button>
      </div>
      <div id="achievementsContainer"></div>
    </div>
  </div>

  <!-- æˆå°±è§£é–é€šçŸ¥ -->
  <div class="modal" id="achievementNotification">
    <div class="modal-content" style="text-align: center;">
      <div class="achievement-icon" id="notificationIcon">ğŸ†</div>
      <h2 id="notificationTitle">æˆå°±è§£é–ï¼</h2>
      <p id="notificationDescription"></p>
      <button class="btn btn-primary" onclick="closeAchievementNotification()">ç¢ºå®š</button>
    </div>
  </div>

  <!-- è³¼è²·æˆåŠŸé€šçŸ¥ Toast -->
  <div class="purchase-toast" id="purchaseToast">
    <div class="purchase-toast-icon">âœ…</div>
    <div class="purchase-toast-content">
      <div class="purchase-toast-title">è³¼è²·æˆåŠŸï¼</div>
      <div class="purchase-toast-message" id="purchaseToastMessage">ç‰©å“å·²æˆåŠŸè³¼è²·</div>
    </div>
    <button class="purchase-toast-close" onclick="closePurchaseToastAndProcessNext()">&times;</button>
  </div>

  <!-- éŒ¯èª¤æç¤º Toast -->
  <div class="error-toast" id="errorToast">
    <div class="error-toast-icon">âš ï¸</div>
    <div class="error-toast-content">
      <div class="error-toast-title" id="errorToastTitle">éŒ¯èª¤</div>
      <div class="error-toast-message" id="errorToastMessage">ç™¼ç”ŸéŒ¯èª¤</div>
    </div>
    <button class="error-toast-close" onclick="closeErrorToast()">&times;</button>
  </div>

  <!-- éŠæˆ²çµç®— Toast -->
  <div class="game-result-toast" id="gameResultToast">
    <div class="game-result-toast-icon">ğŸ®</div>
    <div class="game-result-toast-content">
      <div class="game-result-toast-title">éŠæˆ²çµæŸï¼</div>
      <div class="game-result-toast-message" id="gameResultMessage">
        <div class="result-item">
          <span class="result-label">é»æ“Šæ•¸ï¼š</span>
          <span class="result-value" id="resultClicks">0</span>
        </div>
        <div class="result-item">
          <span class="result-label">ç²å¾—é‡‘å¹£ï¼š</span>
          <span class="result-value coins-value" id="resultCoins">+0 ğŸ’°</span>
        </div>
        <div class="result-loading" id="resultLoading" style="display: none;">
          <span style="opacity: 0.8; font-size: 12px;">æ­£åœ¨å„²å­˜...</span>
        </div>
      </div>
    </div>
    <button class="game-result-toast-close" onclick="closeGameResultToast()">&times;</button>
  </div>

  <!-- å¸³è™Ÿä»‹é¢æ¨¡æ…‹æ¡†ï¼ˆåƒ…ç©å®¶è³‡æ–™ï¼‰ -->
  <div class="modal" id="accountModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ç©å®¶è³‡æ–™ ğŸ‘¤</h2>
        <button class="close-btn" onclick="closeAccount()">&times;</button>
      </div>
      <div id="accountContainer">
        <div id="accountProfileInfo" style="background: #f0f0f0; padding: 15px; border-radius: 5px;">
          <!-- ç©å®¶è³‡æ–™å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
      </div>
    </div>
  </div>

  <!-- å¾½ç« é¸æ“‡æ¨¡æ…‹æ¡† -->
  <div class="modal" id="badgeSelectModal">
    <div class="modal-content badge-select-modal-content">
      <div class="modal-header">
        <h2>é¸æ“‡æˆå°±å¾½ç« </h2>
        <button class="close-btn" onclick="closeBadgeSelect()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 15px; color: #666;">é¸æ“‡è¦é¡¯ç¤ºåœ¨å³ä¸Šè§’çš„æˆå°±å¾½ç« ï¼ˆåƒ…é¡¯ç¤ºå·²è§£é–çš„æˆå°±ï¼‰</p>
        <div id="badgeSelectContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto; overflow-x: hidden;">
          <!-- æˆå°±å¾½ç« é¸æ“‡åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button class="btn btn-primary" onclick="clearBadgeSlot()">æ¸…é™¤ç•¶å‰æ¬„ä½</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ­·å²è¨˜éŒ„æ¨¡æ…‹æ¡† -->
  <div class="modal" id="historyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>éŠæˆ²æ­·å²è¨˜éŒ„ ğŸ“Š</h2>
        <button class="close-btn" onclick="closeHistory()">&times;</button>
      </div>
      <div id="detailedHistoryContainer" style="max-height: 500px; overflow-x: auto; overflow-y: auto;">
        <!-- è©³ç´°æ­·å²è¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
      </div>
    </div>
  </div>

  <!-- è¼‰å…¥ä¸­æ¨¡æ…‹æ¡† -->
  <div class="modal loading-modal" id="loadingModal">
    <div class="modal-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">æ­£åœ¨è™•ç†ä¸­...</div>
      <div class="loading-details" id="loadingDetails"></div>
    </div>
  </div>

  <!-- ç¾åŒ–ç¢ºèªå°è©±æ¡† -->
  <div class="modal" id="confirmModal" onclick="handleModalBackgroundClick(event, 'confirmModal')">
    <div class="modal-content confirm-modal-content" onclick="event.stopPropagation()">
      <div class="confirm-icon">â“</div>
      <h2 class="confirm-title" id="confirmTitle">ç¢ºèª</h2>
      <p class="confirm-message" id="confirmMessage"></p>
      <div class="confirm-buttons">
        <button class="btn btn-secondary" id="confirmCancelBtn" onclick="closeConfirmModal(false)">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="confirmOkBtn" onclick="closeConfirmModal(true)">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ç¾åŒ–æç¤ºå°è©±æ¡† -->
  <div class="modal" id="alertModal" onclick="handleModalBackgroundClick(event, 'alertModal')">
    <div class="modal-content alert-modal-content" onclick="event.stopPropagation()">
      <div class="alert-icon">â„¹ï¸</div>
      <h2 class="alert-title" id="alertTitle">æç¤º</h2>
      <p class="alert-message" id="alertMessage"></p>
      <div class="alert-buttons">
        <button class="btn btn-primary" id="alertOkBtn" onclick="closeAlertModal()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // ç”¨æˆ¶ç«¯è³‡æ–™å„²å­˜ç®¡ç†ç³»çµ±
    // ============================================
    // æ ¹æ“šæœ€ä½³å¯¦è¸ï¼š
    // 1. ç™»å…¥ç‹€æ…‹ (Session) â†’ Cookie (ç”± Django Session ç®¡ç†ï¼ŒHTTP Onlyï¼Œæ›´å®‰å…¨)
    // 2. éŠæˆ²è¨­å®šã€é€²åº¦ â†’ LocalStorage (ç°¡å–®ã€å¿«é€Ÿã€å®¹é‡è¶³å¤ )
    // 3. è¤‡é›œè³‡æ–™é›† â†’ IndexedDB (æœªä¾†æ“´å±•ç”¨)
    
    const StorageManager = {
      // LocalStorage éµåå¸¸é‡
      KEYS: {
        GAME_SETTINGS: 'clickfast_game_settings',
        GAME_PROGRESS: 'clickfast_game_progress',
        LAST_USERNAME: 'clickfast_last_username', // åƒ…ç”¨æ–¼é¡¯ç¤ºï¼Œä¸ä½œç‚ºèªè­‰
      },
      
      // éŠæˆ²è¨­å®šç®¡ç†ï¼ˆä½¿ç”¨ LocalStorageï¼‰
      getGameSettings() {
        try {
          const settings = localStorage.getItem(this.KEYS.GAME_SETTINGS);
          return settings ? JSON.parse(settings) : this.getDefaultSettings();
        } catch (e) {
          console.error('è®€å–éŠæˆ²è¨­å®šå¤±æ•—:', e);
          return this.getDefaultSettings();
        }
      },
      
      saveGameSettings(settings) {
        try {
          localStorage.setItem(this.KEYS.GAME_SETTINGS, JSON.stringify(settings));
        } catch (e) {
          console.error('å„²å­˜éŠæˆ²è¨­å®šå¤±æ•—:', e);
        }
      },
      
      getDefaultSettings() {
        return {
          volume: 1.0, // éŸ³é‡ (0.0 - 1.0)
          soundEnabled: true, // éŸ³æ•ˆé–‹é—œ
          autoSave: true, // è‡ªå‹•å„²å­˜
          theme: 'default', // ä¸»é¡Œ
        };
      },
      
      // è‡¨æ™‚éŠæˆ²é€²åº¦ç®¡ç†ï¼ˆä½¿ç”¨ LocalStorageï¼‰
      getGameProgress() {
        try {
          const progress = localStorage.getItem(this.KEYS.GAME_PROGRESS);
          return progress ? JSON.parse(progress) : null;
        } catch (e) {
          console.error('è®€å–éŠæˆ²é€²åº¦å¤±æ•—:', e);
          return null;
        }
      },
      
      saveGameProgress(progress) {
        try {
          localStorage.setItem(this.KEYS.GAME_PROGRESS, JSON.stringify(progress));
        } catch (e) {
          console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', e);
        }
      },
      
      clearGameProgress() {
        try {
          localStorage.removeItem(this.KEYS.GAME_PROGRESS);
        } catch (e) {
          console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', e);
        }
      },
      
      // æœ€å¾Œä½¿ç”¨çš„ç”¨æˆ¶åï¼ˆåƒ…ç”¨æ–¼ UI é¡¯ç¤ºï¼Œä¸ä½œç‚ºèªè­‰ï¼‰
      getLastUsername() {
        try {
          return localStorage.getItem(this.KEYS.LAST_USERNAME) || '';
        } catch (e) {
          return '';
        }
      },
      
      saveLastUsername(username) {
        try {
          if (username) {
            localStorage.setItem(this.KEYS.LAST_USERNAME, username);
          } else {
            localStorage.removeItem(this.KEYS.LAST_USERNAME);
          }
        } catch (e) {
          console.error('å„²å­˜ç”¨æˆ¶åå¤±æ•—:', e);
        }
      },
      
      // æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™ï¼ˆç™»å‡ºæ™‚ä½¿ç”¨ï¼‰
      clearAllLocalData() {
        try {
          this.clearGameProgress();
          // ä¿ç•™éŠæˆ²è¨­å®šå’Œæœ€å¾Œç”¨æˆ¶åï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
          // å¦‚æœéœ€è¦å®Œå…¨æ¸…é™¤ï¼Œå¯ä»¥å–æ¶ˆè¨»è§£ä»¥ä¸‹å…©è¡Œï¼š
          // localStorage.removeItem(this.KEYS.GAME_SETTINGS);
          // localStorage.removeItem(this.KEYS.LAST_USERNAME);
        } catch (e) {
          console.error('æ¸…é™¤æœ¬åœ°è³‡æ–™å¤±æ•—:', e);
        }
      }
    };
    
    // ç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼ˆä½¿ç”¨ Django Session Cookieï¼Œä¸ä¾è³´ localStorageï¼‰
    (function() {
      // ä½¿ç”¨ç«‹å³åŸ·è¡Œå‡½æ•¸ï¼Œåœ¨ DOM è§£ææ™‚å°±å˜—è©¦åŸ·è¡Œ
      async function checkLoginState() {
        // å„ªåŒ–ï¼šå…ˆæª¢æŸ¥æ˜¯å¦æœ‰ Session Cookieï¼ˆå¿«é€Ÿæª¢æŸ¥ï¼‰
        // å¦‚æœæœ‰ Cookieï¼Œå˜—è©¦è¼‰å…¥è³‡æ–™ï¼ˆéé˜»å¡ï¼‰
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            // DOM è¼‰å…¥å¾Œï¼Œå˜—è©¦éœé»˜æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkSessionAsync();
          });
        } else {
          checkSessionAsync();
        }
      }
      
      async function checkSessionAsync() {
        try {
          // ä½¿ç”¨éœé»˜æ¨¡å¼æª¢æŸ¥ sessionï¼ˆä¸é¡¯ç¤ºéŒ¯èª¤ï¼‰
          const result = await fetch('/api/profile/', {
            method: 'GET',
            credentials: 'include', // åŒ…å« Cookie
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          if (result.ok) {
            // æœ‰æœ‰æ•ˆçš„ sessionï¼Œé¡¯ç¤ºéŠæˆ²å…§å®¹
            applyLoginState();
          }
        } catch (e) {
          // éœé»˜è™•ç†éŒ¯èª¤ï¼Œä¸å½±éŸ¿é é¢è¼‰å…¥
        }
      }
      
      function applyLoginState() {
        const loginPanel = document.getElementById('loginPanel');
        const gameContent = document.getElementById('gameContent');
        const userInfo = document.getElementById('userInfo');
        
        if (loginPanel) loginPanel.style.display = 'none';
        if (gameContent) gameContent.style.display = 'block';
        if (userInfo) userInfo.style.display = 'flex';
      }
      
      // é å¡«æœ€å¾Œä½¿ç”¨çš„ç”¨æˆ¶åï¼ˆæå‡ç”¨æˆ¶é«”é©—ï¼‰
      function prefillUsername() {
        const usernameInput = document.getElementById('usernameInput');
        if (usernameInput && !usernameInput.value) {
          const lastUsername = StorageManager.getLastUsername();
          if (lastUsername) {
            usernameInput.value = lastUsername;
          }
        }
      }
      
      // ç«‹å³åŸ·è¡Œæª¢æŸ¥
      checkLoginState();
      
      // é å¡«ç”¨æˆ¶åï¼ˆDOM è¼‰å…¥å¾Œï¼‰
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', prefillUsername);
      } else {
        prefillUsername();
      }
    })();

    // éŠæˆ²ç‹€æ…‹
    let gameState = {
      isPlaying: false,
      timeRemaining: 5.0,
      clicks: 0,
      gameDuration: 5.0,
      timerInterval: null,
      autoClickerIntervals: [], // æ”¹ç‚ºæ•¸çµ„ï¼Œå­˜å„²æ¯å€‹è‡ªå‹•æŒ‰éˆ•çš„å®šæ™‚å™¨
      userProfile: null,
      purchases: {},
      autoClickerRate: 0, // æ¯ç§’é»æ“Šæ¬¡æ•¸ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
      autoClickerInterval: 0, // é»æ“Šé–“éš”æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
      extraButtons: 0,
      badges: [null, null, null], // ç”¨æˆ¶é¸æ“‡çš„ä¸‰å€‹æˆå°±å¾½ç« 
      unlockedAchievements: [], // ç·©å­˜å·²è§£é–çš„æˆå°±åˆ—è¡¨ï¼Œé¿å…é‡è¤‡ API èª¿ç”¨
    };

    // ç¾åŒ–ç¢ºèªå°è©±æ¡†å‡½æ•¸
    let confirmCallback = null;
    function showConfirmModal(message, title = 'ç¢ºèª') {
      return new Promise((resolve) => {
        confirmCallback = resolve;
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.add('active');
      });
    }

    function closeConfirmModal(result) {
      document.getElementById('confirmModal').classList.remove('active');
      if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
      }
    }

    // ç¾åŒ–æç¤ºå°è©±æ¡†å‡½æ•¸
    let alertCallback = null;
    function showAlertModal(message, title = 'æç¤º', icon = 'â„¹ï¸') {
      return new Promise((resolve) => {
        alertCallback = resolve;
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').textContent = message;
        document.querySelector('#alertModal .alert-icon').textContent = icon;
        document.getElementById('alertModal').classList.add('active');
      });
    }

    function closeAlertModal() {
      document.getElementById('alertModal').classList.remove('active');
      if (alertCallback) {
        alertCallback();
        alertCallback = null;
      }
    }

    // æ›¿æ›åŸç”Ÿ alert å’Œ confirm çš„åŒ…è£å‡½æ•¸
    function customAlert(message, title = 'æç¤º', icon = 'â„¹ï¸') {
      return showAlertModal(message, title, icon);
    }

    function customConfirm(message, title = 'ç¢ºèª') {
      return showConfirmModal(message, title);
    }

    // è™•ç†æ¨¡æ…‹æ¡†èƒŒæ™¯é»æ“Šï¼ˆé»æ“ŠèƒŒæ™¯é—œé–‰ï¼Œä½†é»æ“Šå…§å®¹å€åŸŸä¸é—œé–‰ï¼‰
    function handleModalBackgroundClick(event, modalId) {
      // å¦‚æœé»æ“Šçš„æ˜¯æ¨¡æ…‹æ¡†èƒŒæ™¯ï¼ˆä¸æ˜¯å…§å®¹å€åŸŸï¼‰ï¼Œå‰‡é—œé–‰
      if (event.target.id === modalId) {
        if (modalId === 'confirmModal') {
          closeConfirmModal(false);
        } else if (modalId === 'alertModal') {
          closeAlertModal();
        }
      }
    }

    // API èª¿ç”¨å‡½æ•¸
    async function apiCall(url, method = 'GET', data = null, silent = false, useToast = false) {
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
      };
      
      if (data) {
        options.body = JSON.stringify(data);
      }

      try {
        const response = await fetch(url, options);
        const result = await response.json();
        if (response.ok) {
          return result;
        } else {
          // å°‡å®Œæ•´çš„éŒ¯èª¤è³‡è¨Šå‚³éï¼ŒåŒ…æ‹¬é¡å¤–çš„è³‡æ–™
          const error = new Error(result.error || 'è«‹æ±‚å¤±æ•—');
          error.result = result; // ä¿å­˜å®Œæ•´çš„å›æ‡‰çµæœ
          throw error;
        }
      } catch (error) {
        console.error('API Error:', error);
        
        // å¦‚æœæ˜¯éœé»˜æ¨¡å¼ï¼Œä¸é¡¯ç¤ºä»»ä½•æç¤º
        if (silent) {
          throw error;
        }
        
        // å¦‚æœæ˜¯ã€Œæœªç™»éŒ„ã€éŒ¯èª¤ï¼Œä¸é¡¯ç¤ºæç¤ºï¼ˆé€™æ˜¯æ­£å¸¸æƒ…æ³ï¼‰
        if (error.message && error.message.includes('æœªç™»éŒ„')) {
          throw error;
        }
        
        // å¦‚æœæ˜¯ã€Œé‡‘å¹£ä¸è¶³ã€éŒ¯èª¤ä¸”ä½¿ç”¨ Toastï¼Œé¡¯ç¤ºç¾åŒ–çš„éŒ¯èª¤æç¤º
        if (useToast && error.message && error.message.includes('é‡‘å¹£ä¸è¶³') && error.result) {
          showErrorToast('é‡‘å¹£ä¸è¶³', error.result);
          throw error;
        }
        
        // å…¶ä»–éŒ¯èª¤ï¼šä½¿ç”¨ Toast æˆ– alert
        if (useToast) {
          let errorMessage = error.message;
          if (errorMessage.includes('timeout') || errorMessage.includes('connection') || errorMessage.includes('pooler.supabase.com')) {
            errorMessage = 'ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          } else if (errorMessage.includes('500') || errorMessage.includes('Internal Server Error')) {
            errorMessage = 'ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          }
          showErrorToast('éŒ¯èª¤', errorMessage);
        } else {
          // æª¢æ¸¬è³‡æ–™åº«é€£æ¥éŒ¯èª¤ï¼Œé¡¯ç¤ºæ›´å‹å¥½çš„éŒ¯èª¤è¨Šæ¯
          let errorMessage = error.message;
          if (errorMessage.includes('timeout') || errorMessage.includes('connection') || errorMessage.includes('pooler.supabase.com')) {
            errorMessage = 'ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nå¦‚æœå•é¡ŒæŒçºŒå­˜åœ¨ï¼Œå¯èƒ½æ˜¯è³‡æ–™åº«æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚';
          } else if (errorMessage.includes('500') || errorMessage.includes('Internal Server Error')) {
            errorMessage = 'ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          }
          await customAlert('éŒ¯èª¤: ' + errorMessage, 'éŒ¯èª¤', 'âš ï¸');
        }
        throw error;
      }
    }

    // é¡¯ç¤ºè¼‰å…¥ä¸­è¦–çª—
    function showLoadingModal(message = 'æ­£åœ¨è™•ç†ä¸­...', details = '') {
      document.getElementById('loadingText').textContent = message;
      const detailsEl = document.getElementById('loadingDetails');
      if (details) {
        detailsEl.textContent = details;
        detailsEl.style.display = 'block';
      } else {
        detailsEl.style.display = 'none';
      }
      document.getElementById('loadingModal').classList.add('active');
    }

    // éš±è—è¼‰å…¥ä¸­è¦–çª—
    function hideLoadingModal() {
      document.getElementById('loadingModal').classList.remove('active');
    }

    // ç™»éŒ„æˆ–è¨»å†Š
    async function loginOrRegister() {
      const username = document.getElementById('usernameInput').value.trim();
      if (!username) {
        await customAlert('è«‹è¼¸å…¥ç”¨æˆ¶å', 'æç¤º', 'âš ï¸');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­è¦–çª—
      showLoadingModal('æ­£åœ¨ç™»å…¥ä¸­...', 'æ­£åœ¨é©—è­‰ç”¨æˆ¶åä¸¦å»ºç«‹é€£ç·šï¼Œè«‹ç¨å€™');

      try {
        // æ›´æ–°è¼‰å…¥è¨Šæ¯
        setTimeout(() => {
          if (document.getElementById('loadingModal').classList.contains('active')) {
            document.getElementById('loadingDetails').textContent = 'æ­£åœ¨é€£æ¥è³‡æ–™åº«ä¼ºæœå™¨...';
          }
        }, 1000);

        const result = await apiCall('/api/login/', 'POST', { username });
        
        // æ›´æ–°è¼‰å…¥è¨Šæ¯
        if (document.getElementById('loadingModal').classList.contains('active')) {
          document.getElementById('loadingText').textContent = 'ç™»å…¥æˆåŠŸï¼';
          document.getElementById('loadingDetails').textContent = 'æ­£åœ¨è¼‰å…¥éŠæˆ²è³‡æ–™...';
        }

        if (result.success) {
          // ç™»å…¥ç‹€æ…‹ç”± Django Session Cookie ç®¡ç†ï¼ˆæ›´å®‰å…¨ï¼ŒHTTP Onlyï¼‰
          // åƒ…ä¿å­˜æœ€å¾Œä½¿ç”¨çš„ç”¨æˆ¶ååˆ° LocalStorageï¼ˆç”¨æ–¼ UI é¡¯ç¤ºï¼Œä¸ä½œç‚ºèªè­‰ï¼‰
          StorageManager.saveLastUsername(username);
          
          // æ¸…é™¤ä¹‹å‰çš„æ­·å²è¨˜éŒ„é¡¯ç¤º
          document.getElementById('historyContainer').innerHTML = '<p style="color: #666;">æš«ç„¡è¨˜éŒ„</p>';
          document.getElementById('detailedHistoryContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æš«ç„¡è¨˜éŒ„</p>';
          
          gameState.userProfile = result.profile;
          document.getElementById('loginPanel').style.display = 'none';
          document.getElementById('gameContent').style.display = 'block';
          document.getElementById('userInfo').style.display = 'flex';
          updateProfileDisplay();
          
          // æ›´æ–°è¼‰å…¥è¨Šæ¯
          if (document.getElementById('loadingModal').classList.contains('active')) {
            document.getElementById('loadingDetails').textContent = 'æ­£åœ¨è¼‰å…¥å•†åº—ã€æˆå°±å’Œæ­·å²è¨˜éŒ„...';
          }
          
          // å„ªåŒ–ï¼šè¼‰å…¥å®Œæ•´çš„ profileï¼ˆåŒ…å«è³¼è²·è¨˜éŒ„å’Œå¾½ç« ï¼‰ï¼ŒloadProfile å…§éƒ¨æœƒä¸¦è¡Œè¼‰å…¥å…¶ä»–è³‡æ–™
          await loadProfile();
          
          // æª¢æŸ¥æ˜¯å¦ç‚ºè¶…ç´šå¸³è™Ÿ
          checkSuperAccount();
          
          // æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæ›´æ–°è¼‰å…¥è¨Šæ¯
          if (document.getElementById('loadingModal').classList.contains('active')) {
            document.getElementById('loadingText').textContent = 'è¼‰å…¥å®Œæˆï¼';
            document.getElementById('loadingDetails').textContent = 'æ­¡è¿å›ä¾†ï¼Œé–‹å§‹éŠæˆ²å§ï¼';
          }
          
          // çŸ­æš«å»¶é²å¾Œéš±è—è¼‰å…¥è¦–çª—ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°å®Œæˆè¨Šæ¯
          setTimeout(() => {
            hideLoadingModal();
          }, 800);
        }
      } catch (error) {
        // éš±è—è¼‰å…¥è¦–çª—ï¼ˆéŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†ä¸¦é¡¯ç¤º alertï¼‰
        hideLoadingModal();
      }
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºè¶…ç´šå¸³è™Ÿ
    function checkSuperAccount() {
      const superAccountControls = document.getElementById('superAccountControls');
      if (gameState.userProfile && gameState.userProfile.username === 'super_test') {
        superAccountControls.style.display = 'block';
        // è¨­ç½®ç•¶å‰éŠæˆ²æ™‚é•·ï¼ˆè¶…ç´šå¸³è™Ÿä½¿ç”¨ç¨ç«‹è¨­ç½®ï¼Œä¸å—æ™‚é–“å»¶é•·è³¼è²·å½±éŸ¿ï¼‰
        const timeInput = document.getElementById('superTimeInput');
        const timeDisplay = document.getElementById('superTimeDisplay');
        if (timeInput && timeDisplay) {
          // è¶…ç´šå¸³è™Ÿæ§åˆ¶é¢æ¿å§‹çµ‚ä½¿ç”¨é è¨­å€¼ 5 ç§’ï¼Œä¸å—æ™‚é–“å»¶é•·è³¼è²·å½±éŸ¿
          // å¦‚æœæ»‘æ¡¿å·²ç¶“æœ‰æœ‰æ•ˆå€¼ï¼ˆ5-30ï¼‰ï¼Œä¿æŒå®ƒï¼›å¦å‰‡è¨­ç½®ç‚ºé è¨­å€¼ 5
          let currentTime = 5;
          const existingValue = parseInt(timeInput.value);
          if (existingValue >= 5 && existingValue <= 30) {
            currentTime = existingValue;
          }
          timeInput.value = currentTime;
          timeDisplay.textContent = currentTime + ' ç§’';
          
          // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œé¿å…é‡è¤‡ç¶å®š
          const newTimeInput = timeInput.cloneNode(true);
          timeInput.parentNode.replaceChild(newTimeInput, timeInput);
          
          // æ·»åŠ æ»‘æ¡¿äº‹ä»¶ç›£è½
          newTimeInput.addEventListener('input', function() {
            const newTime = parseInt(this.value);
            timeDisplay.textContent = newTime + ' ç§’';
            if (!gameState.isPlaying) {
              updateSuperTime(newTime);
            }
          });
        }
        
        // å•†åº—ç­‰ç´šå›æº¯åŠŸèƒ½å·²ç°¡åŒ–ï¼Œç„¡éœ€åˆå§‹åŒ–
      } else {
        superAccountControls.style.display = 'none';
      }
    }

    // æ‰¹é‡å›æº¯æ‰€æœ‰å•†åº—ç‰©å“åˆ°åˆå§‹ç‹€æ…‹
    async function rollbackAllShopItems() {
      const rollbackAllButton = document.getElementById('rollbackAllButton');
      
      const confirmed = await customConfirm('ç¢ºå®šè¦å°‡æ‰€æœ‰å•†åº—ç‰©å“å›æº¯åˆ°åˆå§‹ç‹€æ…‹ï¼ˆç­‰ç´š 0ï¼‰å—ï¼Ÿ', 'ç¢ºèªå›æº¯');
      if (!confirmed) {
        return;
      }
      
      // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
      rollbackAllButton.disabled = true;
      rollbackAllButton.textContent = 'å›æº¯ä¸­...';
      
      try {
        const result = await apiCall('/api/rollback-all-shop-items/', 'POST');
        
        if (result.success) {
          // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
          if (result.rolled_back_count > 0) {
            await customAlert(result.message, 'æç¤º', 'âœ…');
          } else {
            await customAlert('æ²’æœ‰éœ€è¦å›æº¯çš„å•†åº—ç‰©å“', 'æç¤º', 'â„¹ï¸');
          }
          
          // é‡æ–°åŠ è¼‰è³‡æ–™
          await loadProfile();
          await loadShop();
        }
      } catch (error) {
        // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        rollbackAllButton.disabled = false;
        rollbackAllButton.textContent = 'ğŸ”„ å…¨éƒ¨å›æº¯';
      }
    }

    // æ›´æ–°è¶…ç´šå¸³è™Ÿçš„éŠæˆ²æ™‚é•·
    function updateSuperTime(newTime) {
      if (gameState.isPlaying) {
        return; // éŠæˆ²é€²è¡Œä¸­ä¸å…è¨±ä¿®æ”¹
      }
      
      if (newTime === undefined) {
        const timeInput = document.getElementById('superTimeInput');
        if (timeInput) {
          newTime = parseInt(timeInput.value);
        } else {
          return;
        }
      }
      
      if (isNaN(newTime) || newTime < 1 || newTime > 30) {
        return;
      }
      
      gameState.gameDuration = newTime;
      gameState.timeRemaining = newTime;
      document.getElementById('timerDisplay').textContent = newTime + ' ç§’';
    }

    // ç™»å‡ºç”¨æˆ¶
    async function logoutUser() {
      const confirmed = await customConfirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', 'ç¢ºèªç™»å‡º');
      if (!confirmed) {
        return;
      }

      try {
        // åœæ­¢æ‰€æœ‰éŠæˆ²è¨ˆæ™‚å™¨
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
        }
        // æ¸…é™¤æ‰€æœ‰è‡ªå‹•é»æ“Šå™¨å®šæ™‚å™¨
        gameState.autoClickerIntervals.forEach(interval => clearInterval(interval));
        gameState.autoClickerIntervals = [];

        // èª¿ç”¨ç™»å‡º API
        await apiCall('/api/logout/', 'POST');
        
        // ç™»å…¥ç‹€æ…‹ç”± Django Session Cookie ç®¡ç†ï¼Œç™»å‡ºæ™‚æœƒè‡ªå‹•æ¸…é™¤
        // æ¸…é™¤æœ¬åœ°éŠæˆ²é€²åº¦ï¼ˆä¿ç•™è¨­å®šå’Œæœ€å¾Œç”¨æˆ¶åï¼‰
        StorageManager.clearAllLocalData();
        
        // é‡ç½®éŠæˆ²ç‹€æ…‹
        gameState = {
          isPlaying: false,
          timeRemaining: 5.0,
          clicks: 0,
          gameDuration: 5.0,
          timerInterval: null,
          autoClickerIntervals: [],
          userProfile: null,
          purchases: {},
          autoClickerRate: 0,
          autoClickerInterval: 0,
          extraButtons: 0,
          badges: [null, null, null],
        };

        // é¡¯ç¤ºç™»å…¥é¢æ¿ï¼Œéš±è—éŠæˆ²å…§å®¹
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('gameContent').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('usernameInput').value = '';
        
        // é—œé–‰æ‰€æœ‰æ¨¡æ…‹æ¡†
        document.getElementById('shopModal').classList.remove('active');
        document.getElementById('achievementsModal').classList.remove('active');
        document.getElementById('accountModal').classList.remove('active');
        document.getElementById('historyModal').classList.remove('active');
        document.getElementById('achievementNotification').classList.remove('active');
        
        // æ¸…é™¤æ­·å²è¨˜éŒ„é¡¯ç¤º
        document.getElementById('historyContainer').innerHTML = '<p style="color: #666;">æš«ç„¡è¨˜éŒ„</p>';
        document.getElementById('detailedHistoryContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æš«ç„¡è¨˜éŒ„</p>';
      } catch (error) {
        // å³ä½¿ API èª¿ç”¨å¤±æ•—ï¼Œä¹ŸåŸ·è¡Œç™»å‡ºæ“ä½œ
        gameState = {
          isPlaying: false,
          timeRemaining: 5.0,
          clicks: 0,
          gameDuration: 5.0,
          timerInterval: null,
          autoClickerIntervals: [],
          userProfile: null,
          purchases: {},
          autoClickerRate: 0,
          extraButtons: 0,
        };
        document.getElementById('loginPanel').style.display = 'block';
        document.getElementById('gameContent').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('usernameInput').value = '';
        // é—œé–‰æ‰€æœ‰æ¨¡æ…‹æ¡†
        document.getElementById('shopModal').classList.remove('active');
        document.getElementById('achievementsModal').classList.remove('active');
        document.getElementById('accountModal').classList.remove('active');
        document.getElementById('historyModal').classList.remove('active');
        document.getElementById('achievementNotification').classList.remove('active');
        
        // æ¸…é™¤æ­·å²è¨˜éŒ„é¡¯ç¤º
        document.getElementById('historyContainer').innerHTML = '<p style="color: #666;">æš«ç„¡è¨˜éŒ„</p>';
        document.getElementById('detailedHistoryContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æš«ç„¡è¨˜éŒ„</p>';
      }
    }

    // æ›´æ–°è³‡æ–™é¡¯ç¤º
    function updateProfileDisplay() {
      if (!gameState.userProfile) return;
      // æ›´æ–°å¸³è™Ÿåç¨±ï¼ˆåŠ ä¸Š ID: å‰ç¶´ï¼‰
      if (gameState.userProfile.username) {
        document.getElementById('usernameDisplay').textContent = 'ID: ' + gameState.userProfile.username;
      }
      document.getElementById('coinsDisplay').textContent = gameState.userProfile.coins;
      document.getElementById('totalClicksDisplay').textContent = gameState.userProfile.total_clicks;
      document.getElementById('bestClicksDisplay').textContent = gameState.userProfile.best_clicks_per_round;
      document.getElementById('gamesPlayedDisplay').textContent = gameState.userProfile.total_games_played;
      
      // æ›´æ–°å¾½ç« é¡¯ç¤º
      updateBadgesDisplay();
    }

    // æ›´æ–°å¾½ç« é¡¯ç¤º
    function updateBadgesDisplay() {
      const badges = gameState.badges || [null, null, null];
      for (let i = 0; i < 3; i++) {
        const slot = document.getElementById(`badgeSlot${i + 1}`);
        const icon = document.getElementById(`badgeIcon${i + 1}`);
        if (badges[i]) {
          icon.textContent = badges[i].icon;
          slot.classList.add('has-badge');
          slot.title = badges[i].name;
        } else {
          icon.textContent = '-';
          slot.classList.remove('has-badge');
          slot.title = 'é»æ“Šé¸æ“‡å¾½ç« ';
        }
      }
    }

    // åŠ è¼‰ç©å®¶è³‡æ–™
    let isReloadingProfile = false; // é˜²æ­¢ç„¡é™éè¿´
    async function loadProfile(skipAutoRelogin = false) {
      // å¦‚æœæ­£åœ¨é‡æ–°è¼‰å…¥ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
      if (isReloadingProfile) return;
      
      try {
        // ä½¿ç”¨éœé»˜æ¨¡å¼ï¼Œé¿å…æœªç™»éŒ„æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        const result = await apiCall('/api/profile/', 'GET', null, true);
        isReloadingProfile = false; // é‡ç½®æ¨™è¨˜
        
        gameState.userProfile = result.profile;
        gameState.purchases = result.purchases || {};
        gameState.badges = result.badges || [null, null, null];
        // ç·©å­˜å·²è§£é–çš„æˆå°±åˆ—è¡¨ï¼Œå„ªåŒ–å¾½ç« é¸æ“‡éŸ¿æ‡‰é€Ÿåº¦
        gameState.unlockedAchievements = result.achievements || [];
        updateProfileDisplay();
        updateGameUpgrades();
        // å¦‚æœæˆåŠŸåŠ è¼‰è³‡æ–™ï¼Œè¡¨ç¤ºå·²ç™»éŒ„ï¼Œé¡¯ç¤ºéŠæˆ²å…§å®¹
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('gameContent').style.display = 'block';
        document.getElementById('userInfo').style.display = 'flex';
        
        // ä¿å­˜æœ€å¾Œä½¿ç”¨çš„ç”¨æˆ¶ååˆ° LocalStorageï¼ˆç”¨æ–¼ UI é¡¯ç¤ºï¼Œä¸ä½œç‚ºèªè­‰ï¼‰
        if (result.profile && result.profile.username) {
          StorageManager.saveLastUsername(result.profile.username);
        }
        
        // å„ªåŒ–ï¼šä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼Œæ¸›å°‘ç­‰å¾…æ™‚é–“
        // ç­‰å¾…æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆï¼Œç¢ºä¿è¼‰å…¥è¦–çª—åœ¨è³‡æ–™å®Œå…¨è¼‰å…¥å¾Œæ‰é—œé–‰
        await Promise.all([
          loadShop(),
          loadAchievements(),
          loadHistory()
        ]).catch(error => {
          console.error('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        });
        // æª¢æŸ¥æ˜¯å¦ç‚ºè¶…ç´šå¸³è™Ÿ
        checkSuperAccount();
      } catch (error) {
        isReloadingProfile = false; // é‡ç½®æ¨™è¨˜
        
        // å¦‚æœæœªç™»éŒ„ä¸”æœªè·³éè‡ªå‹•é‡æ–°ç™»å…¥ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰æœ€å¾Œä½¿ç”¨çš„ç”¨æˆ¶å
        // å¦‚æœæœ‰ï¼Œå¯ä»¥å˜—è©¦è‡ªå‹•é‡æ–°ç™»å…¥ï¼ˆå¯èƒ½æ˜¯ session éæœŸä½†ç”¨æˆ¶ä»æƒ³ä¿æŒç™»å…¥ï¼‰
        if (!skipAutoRelogin) {
          const lastUsername = StorageManager.getLastUsername();
          
          if (lastUsername) {
            // å˜—è©¦è‡ªå‹•é‡æ–°ç™»å…¥
            isReloadingProfile = true; // è¨­ç½®æ¨™è¨˜ï¼Œé˜²æ­¢éè¿´
            // é¡¯ç¤ºè¼‰å…¥ä¸­è¦–çª—
            showLoadingModal('æ­£åœ¨é‡æ–°ç™»å…¥ä¸­...', 'åµæ¸¬åˆ°å·²ä¿å­˜çš„ç™»å…¥ç‹€æ…‹ï¼Œæ­£åœ¨é‡æ–°é€£ç·š...');
            try {
              const result = await apiCall('/api/login/', 'POST', { username: lastUsername }, true);
              if (result.success) {
                // æ›´æ–°è¼‰å…¥è¨Šæ¯
                if (document.getElementById('loadingModal').classList.contains('active')) {
                  document.getElementById('loadingText').textContent = 'é‡æ–°ç™»å…¥æˆåŠŸï¼';
                  document.getElementById('loadingDetails').textContent = 'æ­£åœ¨è¼‰å…¥å•†åº—ã€æˆå°±å’Œæ­·å²è¨˜éŒ„...';
                }
                // é‡æ–°ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆè·³éè‡ªå‹•é‡æ–°ç™»å…¥ï¼Œé¿å…ç„¡é™éè¿´ï¼‰
                await loadProfile(true);
                
                // æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæ›´æ–°è¼‰å…¥è¨Šæ¯
                if (document.getElementById('loadingModal').classList.contains('active')) {
                  document.getElementById('loadingText').textContent = 'è¼‰å…¥å®Œæˆï¼';
                  document.getElementById('loadingDetails').textContent = 'æ­¡è¿å›ä¾†ï¼Œé–‹å§‹éŠæˆ²å§ï¼';
                }
                
                // éš±è—è¼‰å…¥è¦–çª—
                setTimeout(() => {
                  hideLoadingModal();
                }, 800);
                return;
              }
            } catch (loginError) {
              // è‡ªå‹•ç™»å…¥å¤±æ•—ï¼Œæ¸…é™¤æœ€å¾Œç”¨æˆ¶åä¸¦é¡¯ç¤ºç™»å…¥é¢æ¿
              StorageManager.saveLastUsername(''); // æ¸…é™¤æœ€å¾Œç”¨æˆ¶å
              hideLoadingModal();
            }
          }
        }
        // å¦‚æœæœªç™»éŒ„ï¼Œä¿æŒç™»éŒ„é¢æ¿é¡¯ç¤º
        // é€™æ˜¯æ­£å¸¸æƒ…æ³ï¼Œä¸éœ€è¦è™•ç†ï¼Œä¹Ÿä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      }
    }

    // æ›´æ–°éŠæˆ²å‡ç´š
    function updateGameUpgrades() {
      // æ›´æ–°éŠæˆ²æ™‚é•·
      if (gameState.purchases.time_extension) {
        gameState.gameDuration = 5.0 + gameState.purchases.time_extension.effect_value;
      } else {
        gameState.gameDuration = 5.0;
      }

      // æ›´æ–°é¡å¤–æŒ‰éˆ•
      // å…ˆé‡ç½®ç‚º0ï¼Œç„¶å¾Œæ ¹æ“šè³¼è²·è¨˜éŒ„è¨­ç½®
      gameState.extraButtons = 0;
      if (gameState.purchases.extra_button && gameState.purchases.extra_button.level > 0) {
        gameState.extraButtons = gameState.purchases.extra_button.effect_value;
      }
      updateClickButtons();

      // æ›´æ–°è‡ªå‹•é»æ“Šå™¨
      // æ ¹æ“šç­‰ç´šè¨ˆç®—é»æ“Šé »ç‡ï¼š
      // ç­‰ç´š1ï¼š3ç§’é»æ“Šä¸€æ¬¡
      // ç­‰ç´š2ï¼š2ç§’é»æ“Šä¸€æ¬¡
      // ç­‰ç´š3ï¼š1ç§’é»æ“Šä¸€æ¬¡
      // ç­‰ç´š4+ï¼š1ç§’é»æ“Š(ç­‰ç´š-2)æ¬¡
      if (gameState.purchases.auto_clicker) {
        const level = gameState.purchases.auto_clicker.level;
        if (level <= 3) {
          // ç­‰ç´š1-3ï¼šä½¿ç”¨é–“éš”æ™‚é–“ï¼ˆ3ç§’ã€2ç§’ã€1ç§’ï¼‰
          gameState.autoClickerRate = 1 / (4 - level); // è½‰æ›ç‚ºæ¯ç§’é»æ“Šæ¬¡æ•¸ï¼Œç”¨æ–¼é¡¯ç¤º
          gameState.autoClickerInterval = (4 - level) * 1000; // é–“éš”æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        } else {
          // ç­‰ç´š4+ï¼šæ¯ç§’é»æ“Š(ç­‰ç´š-2)æ¬¡
          gameState.autoClickerRate = level - 2; // æ¯ç§’é»æ“Šæ¬¡æ•¸
          gameState.autoClickerInterval = 1000 / (level - 2); // é–“éš”æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        }
      } else {
        gameState.autoClickerRate = 0;
        gameState.autoClickerInterval = 0;
      }
      
      // æ›´æ–°è‡ªå‹•é»æ“Šå™¨é¡¯ç¤ºï¼ˆéœ€è¦åŒæ™‚æœ‰è‡ªå‹•é»æ“Šå™¨å’Œé¡å¤–æŒ‰éˆ•ï¼‰
      const infoDiv = document.getElementById('autoClickerInfo');
      if (gameState.autoClickerRate > 0 && gameState.extraButtons > 0) {
        infoDiv.style.display = 'block';
        // è¨ˆç®—å¯¦éš›ç¸½é»æ“Šé »ç‡ï¼šæ¯å€‹æŒ‰éˆ•çš„é »ç‡ Ã— æŒ‰éˆ•æ•¸é‡
        const totalClickRate = gameState.autoClickerRate * gameState.extraButtons;
        // æ›´æ–°é¡¯ç¤ºï¼šæ¯å€‹é»æ“Šå™¨é »ç‡ã€æ•¸é‡ã€ç¸½é »ç‡
        document.getElementById('autoClickerRatePerButton').textContent = gameState.autoClickerRate.toFixed(2);
        document.getElementById('autoClickerCount').textContent = gameState.extraButtons;
        document.getElementById('autoClickerTotalRate').textContent = totalClickRate.toFixed(2);
      } else {
        infoDiv.style.display = 'none';
      }

      // æ›´æ–°è¶…ç´šå¸³è™Ÿæ§åˆ¶é¢æ¿çš„æ™‚é–“é¡¯ç¤º
      // æ³¨æ„ï¼šè¶…ç´šå¸³è™Ÿçš„æ™‚é–“è¨­ç½®ä¸æ‡‰è¢«æ™‚é–“å»¶é•·è³¼è²·å½±éŸ¿
      // åªæœ‰åœ¨æ»‘æ¡¿æ²’æœ‰è¢«æ‰‹å‹•è¨­ç½®æ™‚æ‰æ›´æ–°
      if (gameState.userProfile && gameState.userProfile.username === 'super_test') {
        const superTimeInput = document.getElementById('superTimeInput');
        const superTimeDisplay = document.getElementById('superTimeDisplay');
        if (superTimeInput && superTimeDisplay) {
          // ä¿æŒç•¶å‰æ»‘æ¡¿çš„å€¼ï¼Œä¸æ ¹æ“š gameDuration æ›´æ–°
          // é€™æ¨£å¯ä»¥é¿å…æ™‚é–“å»¶é•·è³¼è²·å½±éŸ¿è¶…ç´šå¸³è™Ÿçš„æ‰‹å‹•è¨­ç½®
          const currentTime = parseInt(superTimeInput.value) || 5;
          if (currentTime >= 5 && currentTime <= 30) {
            superTimeDisplay.textContent = currentTime + ' ç§’';
          } else {
            // å¦‚æœå€¼ä¸åœ¨åˆç†ç¯„åœå…§ï¼Œé‡ç½®ç‚º 5
            superTimeInput.value = 5;
            superTimeDisplay.textContent = '5 ç§’';
          }
        }
      }
    }

    // æ›´æ–°é»æ“ŠæŒ‰éˆ•
    function updateClickButtons() {
      const container = document.getElementById('clickButtonsContainer');
      container.innerHTML = '';
      
      // å‹•ç‰©emojiåˆ—è¡¨ï¼ˆç”±å°åˆ°å¤§ï¼‰
      const animalEmojis = ['ğŸ­', 'ğŸ±', 'ğŸ¦', 'ğŸ˜', 'ğŸ¦'];
      
      // ä¸»æŒ‰éˆ•å®¹å™¨ï¼ˆç¨ç«‹ä¸€è¡Œï¼‰
      const mainButtonWrapper = document.createElement('div');
      mainButtonWrapper.className = 'main-button-wrapper';
      
      // ä¸»æŒ‰éˆ•ï¼ˆæ‰‹å‹•é»æ“Šï¼Œä¿æŒæ»‘é¼ åœ–æ¨™ï¼‰
      const mainButton = document.createElement('button');
      mainButton.className = 'click-button';
      mainButton.id = 'mainClickButton';
      // å¦‚æœéŠæˆ²æœªé–‹å§‹ï¼Œç¦ç”¨æŒ‰éˆ•ï¼ˆé¡¯ç¤ºç‚ºç°è‰²ï¼‰
      if (!gameState.isPlaying) {
        mainButton.disabled = true;
      }
      const mainButtonText = document.createElement('span');
      mainButtonText.className = 'button-text';
      mainButtonText.textContent = 'é»æ“Šï¼';
      mainButton.appendChild(mainButtonText);
      
      // åŒæ™‚æ”¯æŒé»æ“Šå’Œè§¸æ§äº‹ä»¶ï¼Œç¢ºä¿æ‰‹æ©Ÿå¿«é€Ÿé€£é»æ­£å¸¸
      mainButton.onclick = handleClick;
      
      // ä½¿ç”¨ touchstart ç«‹å³éŸ¿æ‡‰ï¼Œæä¾›æœ€ä½³å¿«é€Ÿé€£é»é«”é©—
      // å°‡ touchStartTime å­˜å„²åœ¨æŒ‰éˆ•çš„æ•¸æ“šå±¬æ€§ä¸­ï¼Œé¿å…ä½œç”¨åŸŸå•é¡Œ
      mainButton.addEventListener('touchstart', function(e) {
        if (gameState.isPlaying) {
          // ç«‹å³è§¸ç™¼é»æ“Š
          handleClick(e);
          // è¨˜éŒ„è§¸æ‘¸é–‹å§‹æ™‚é–“
          this.dataset.touchStartTime = Date.now().toString();
        }
      }, { passive: true });
      
      // touchend ä¹Ÿè™•ç†ï¼Œä½†åªåœ¨ touchstart å¾Œä¸€å®šæ™‚é–“æ‰è§¸ç™¼ï¼ˆé¿å…é‡è¤‡ï¼‰
      mainButton.addEventListener('touchend', function(e) {
        if (gameState.isPlaying) {
          const touchStartTime = parseInt(this.dataset.touchStartTime || '0');
          const now = Date.now();
          // å¦‚æœ touchstart å’Œ touchend é–“éš”è¼ƒé•·ï¼ˆ>100msï¼‰ï¼Œå¯èƒ½æ˜¯å–®ç¨çš„é»æ“Š
          if (touchStartTime > 0 && now - touchStartTime > 100) {
            handleClick(e);
          }
        }
      }, { passive: true });
      
      mainButtonWrapper.appendChild(mainButton);
      container.appendChild(mainButtonWrapper);

      // å¦‚æœæœ‰è‡ªå‹•é»æ“ŠæŒ‰éˆ•ï¼Œå‰µå»ºè‡ªå‹•é»æ“ŠæŒ‰éˆ•å®¹å™¨
      if (gameState.extraButtons > 0) {
        const autoClickWrapper = document.createElement('div');
        autoClickWrapper.className = 'auto-click-buttons-wrapper';
        
        // é¡å¤–æŒ‰éˆ•ï¼ˆè‡ªå‹•é»æ“ŠæŒ‰éˆ•ï¼Œä½¿ç”¨æ©Ÿå™¨äººåœ–æ¨™ï¼‰
        for (let i = 0; i < gameState.extraButtons; i++) {
          const extraButton = document.createElement('button');
          extraButton.className = 'click-button auto-click-button'; // æ·»åŠ auto-click-buttoné¡
          extraButton.id = `autoClickButton${i + 1}`; // ç‚ºæ¯å€‹æŒ‰éˆ•è¨­ç½®å”¯ä¸€ID
          // æ›´æ–°æŒ‰éˆ•åç¨±ï¼šæ”¹ç‚º"AutoClick" + å‹•ç‰©emoji
          const buttonText = document.createElement('span');
          buttonText.className = 'button-text';
          const animalEmoji = animalEmojis[i] || 'ğŸ¤–'; // å¦‚æœè¶…é5å€‹ï¼Œä½¿ç”¨æ©Ÿå™¨äºº
          buttonText.textContent = `AutoClick ${animalEmoji}`;
          extraButton.appendChild(buttonText);
          // ä¸å…è¨±ç”¨æˆ¶é»æ“Šè‡ªå‹•é»æ“ŠæŒ‰éˆ•
          extraButton.disabled = true;
          extraButton.style.pointerEvents = 'none';
          autoClickWrapper.appendChild(extraButton);
        }
        
        container.appendChild(autoClickWrapper);
      }
    }

    // é–‹å§‹éŠæˆ²
    function startGame() {
      if (gameState.isPlaying) return;

      gameState.isPlaying = true;
      gameState.clicks = 0;
      gameState.timeRemaining = gameState.gameDuration;
      document.getElementById('startButton').disabled = true;
      document.getElementById('clicksDisplay').textContent = '0 æ¬¡é»æ“Š';
      document.getElementById('timerDisplay').textContent = gameState.gameDuration.toFixed(1) + ' ç§’';
      
      // å•Ÿç”¨é»æ“ŠæŒ‰éˆ•
      const mainButton = document.getElementById('mainClickButton');
      if (mainButton) {
        mainButton.disabled = false;
      }
      
      updateClickButtons();

      // æ›´æ–°è¨ˆæ™‚å™¨
      gameState.timerInterval = setInterval(() => {
        gameState.timeRemaining -= 0.1;
        if (gameState.timeRemaining <= 0) {
          gameState.timeRemaining = 0;
          endGame();
        }
        document.getElementById('timerDisplay').textContent = gameState.timeRemaining.toFixed(1) + ' ç§’';
      }, 100);

      // è‡ªå‹•é»æ“Šå™¨ï¼šæ‰€æœ‰é¡å¤–æŒ‰éˆ•ä»¥ç›¸åŒé »ç‡åŒæ™‚è§¸ç™¼
      // æ¯å€‹æŒ‰éˆ•ä»¥ autoClickerInterval çš„é–“éš”è‡ªå‹•é»æ“Š
      if (gameState.autoClickerRate > 0 && gameState.extraButtons > 0) {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨
        gameState.autoClickerIntervals.forEach(interval => clearInterval(interval));
        gameState.autoClickerIntervals = [];
        
        // ä½¿ç”¨é å…ˆè¨ˆç®—çš„é–“éš”æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
        const clickInterval = gameState.autoClickerInterval;
        
        // æ›´æ–°é¡¯ç¤ºçš„å¯¦éš›ç¸½é»æ“Šé »ç‡
        const totalClickRate = gameState.autoClickerRate * gameState.extraButtons;
        // æ›´æ–°é¡¯ç¤ºï¼šæ¯å€‹é»æ“Šå™¨é »ç‡ã€æ•¸é‡ã€ç¸½é »ç‡
        const ratePerButtonElement = document.getElementById('autoClickerRatePerButton');
        const countElement = document.getElementById('autoClickerCount');
        const totalRateElement = document.getElementById('autoClickerTotalRate');
        if (ratePerButtonElement) {
          ratePerButtonElement.textContent = gameState.autoClickerRate.toFixed(2);
        }
        if (countElement) {
          countElement.textContent = gameState.extraButtons;
        }
        if (totalRateElement) {
          totalRateElement.textContent = totalClickRate.toFixed(2);
        }
        
        // å‰µå»ºå–®ä¸€å®šæ™‚å™¨ï¼ŒåŒæ™‚è§¸ç™¼æ‰€æœ‰æŒ‰éˆ•
        const interval = setInterval(() => {
          // æª¢æŸ¥éŠæˆ²æ˜¯å¦é‚„åœ¨é€²è¡Œ
          if (!gameState.isPlaying) {
            clearInterval(interval);
            return;
          }
          
          // ç‚ºæ¯å€‹é¡å¤–æŒ‰éˆ•å¢åŠ é»æ“Šæ•¸
          for (let i = 0; i < gameState.extraButtons; i++) {
            gameState.clicks++;
          }
          updateClicksDisplay();
          
          // åŒæ™‚è§¸ç™¼æ‰€æœ‰é¡å¤–æŒ‰éˆ•çš„ç‰¹æ•ˆ
          for (let i = 0; i < gameState.extraButtons; i++) {
            const buttonId = `autoClickButton${i + 1}`;
            const button = document.getElementById(buttonId);
            if (button && gameState.isPlaying) {
              // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„å‹•ç•«é¡ï¼Œç¢ºä¿å‹•ç•«èƒ½é‡æ–°è§¸ç™¼
              button.classList.remove('auto-click-animation');
              // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ DOM æ›´æ–°å¾Œå†æ·»åŠ å‹•ç•«
              requestAnimationFrame(() => {
                if (gameState.isPlaying && button) {
                  button.classList.add('auto-click-animation');
                  // å‹•ç•«æ™‚é•·æ˜¯ 0.4s (400ms)ï¼Œæ‰€ä»¥è¨­ç½® 450ms å¾Œç§»é™¤ï¼Œç¢ºä¿å‹•ç•«å®Œæˆ
                  setTimeout(() => {
                    if (button) {
                      button.classList.remove('auto-click-animation');
                    }
                  }, 450);
                }
              });
            }
          }
        }, clickInterval);
        
        gameState.autoClickerIntervals.push(interval);
      }
    }

    // è™•ç†é»æ“Šï¼ˆå„ªåŒ–å¿«é€Ÿé€£é»éŸ¿æ‡‰ï¼‰
    let lastClickTime = 0;
    function handleClick(event) {
      if (!gameState.isPlaying) return;
      
      // é˜²æ­¢é‡è¤‡è§¸ç™¼ï¼ˆtouchstart å’Œ touchend å¯èƒ½éƒ½æœƒè§¸ç™¼ï¼‰
      const now = Date.now();
      if (now - lastClickTime < 50) {
        return; // 50ms å…§åªè™•ç†ä¸€æ¬¡
      }
      lastClickTime = now;
      
      gameState.clicks++;
      updateClicksDisplay();
      
      // è§¸ç™¼ç‰¹æ•ˆå‹•ç•«ï¼ˆåªæ‡‰ç”¨æ–¼ä¸»æŒ‰éˆ•ï¼‰
      if (event && event.target) {
        const button = event.target;
        // ç¢ºä¿åªå°ä¸»æŒ‰éˆ•æ‡‰ç”¨å‹•ç•«ï¼Œé¿å…å½±éŸ¿å…¶ä»–æŒ‰éˆ•
        // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•å…§çš„spanï¼Œå‰‡æ‰¾åˆ°çˆ¶æŒ‰éˆ•
        const targetButton = button.id === 'mainClickButton' 
          ? button 
          : (button.closest && button.closest('#mainClickButton')) 
            ? button.closest('#mainClickButton')
            : null;
        
        if (targetButton && targetButton.id === 'mainClickButton') {
          // è§¸ç™¼æ–‡å­—ä¸‹æ²‰ä¸Šæµ®å‹•ç•«ï¼ˆä½¿ç”¨è¼ƒçŸ­çš„å‹•ç•«æ™‚é–“ä»¥æ”¯æŒå¿«é€Ÿé€£é»ï¼‰
          targetButton.classList.add('click-text-animation');
          setTimeout(() => {
            targetButton.classList.remove('click-text-animation');
          }, 300);
          
          // è§¸ç™¼è‡ªå‹•é»æ“Šç‰¹æ•ˆï¼ˆèˆ‡è‡ªå‹•é»æ“ŠæŒ‰éˆ•ç›¸åŒçš„ç‰¹æ•ˆï¼‰
          targetButton.classList.remove('auto-click-animation');
          requestAnimationFrame(() => {
            if (gameState.isPlaying && targetButton) {
              targetButton.classList.add('auto-click-animation');
              setTimeout(() => {
                if (targetButton) {
                  targetButton.classList.remove('auto-click-animation');
                }
              }, 400);
            }
          });
        }
      }
    }

    // æ›´æ–°é»æ“Šé¡¯ç¤º
    function updateClicksDisplay() {
      document.getElementById('clicksDisplay').textContent = Math.floor(gameState.clicks) + ' æ¬¡é»æ“Š';
    }

    // è¨ˆç®—é‡‘å¹£ï¼ˆèˆ‡å¾Œç«¯é‚è¼¯ä¸€è‡´ï¼‰
    function calculateCoinsEarned(clicks, gameDuration) {
      const baseTime = 10.0;
      if (gameDuration <= baseTime) {
        // åŸºç¤æ™‚é–“å…§çš„é»æ“Šï¼Œæ¯æ¬¡1é‡‘å¹£
        return clicks;
      } else {
        // æœ‰å»¶é•·æ™‚é–“ï¼Œéœ€è¦å€åˆ†åŸºç¤æ™‚é–“å’Œå»¶é•·æ™‚é–“çš„é»æ“Š
        // å‡è¨­é»æ“Šå‡å‹»åˆ†ä½ˆï¼Œè¨ˆç®—åŸºç¤æ™‚é–“å’Œå»¶é•·æ™‚é–“çš„é»æ“Šæ•¸
        // å»¶é•·æ™‚é–“å…§çš„é»æ“Šç²å¾—2å€é‡‘å¹£ï¼ˆç›¸å°æ–¼åŸºç¤æ™‚é–“çš„1é‡‘å¹£ï¼‰
        const baseClicks = Math.floor(clicks * (baseTime / gameDuration));
        const extraClicks = clicks - baseClicks;
        return baseClicks + (extraClicks * 2);
      }
    }

    // çµæŸéŠæˆ²
    async function endGame() {
      // å…ˆåœæ­¢éŠæˆ²ç‹€æ…‹ï¼Œé˜²æ­¢æ–°çš„å‹•ç•«è§¸ç™¼
      gameState.isPlaying = false;
      
      // æ¸…é™¤è¨ˆæ™‚å™¨
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
      
      // æ¸…é™¤æ‰€æœ‰è‡ªå‹•é»æ“Šå™¨å®šæ™‚å™¨
      gameState.autoClickerIntervals.forEach(interval => {
        if (interval) {
          clearInterval(interval);
        }
      });
      gameState.autoClickerIntervals = [];
      
      // ç­‰å¾…æ‰€æœ‰å‹•ç•«å®Œæˆå¾Œå†ç¹¼çºŒï¼ˆçµ¦å‹•ç•«ä¸€äº›æ™‚é–“å®Œæˆï¼‰
      await new Promise(resolve => setTimeout(resolve, 500));

      const finalClicks = Math.floor(gameState.clicks);
      document.getElementById('timerDisplay').textContent = '0.0 ç§’';
      document.getElementById('startButton').disabled = false;
      
      // ç¦ç”¨é»æ“ŠæŒ‰éˆ•ï¼ˆéŠæˆ²çµæŸå¾Œè®Šç‚ºç°è‰²ï¼‰
      const mainButton = document.getElementById('mainClickButton');
      if (mainButton) {
        mainButton.disabled = true;
      }

      // å„ªåŒ–ï¼šå…ˆåœ¨å‰ç«¯è¨ˆç®—ä¸¦ç«‹å³é¡¯ç¤ºçµç®—çµæœ
      const coinsEarned = calculateCoinsEarned(finalClicks, gameState.gameDuration);
      const currentCoins = gameState.userProfile ? gameState.userProfile.coins : 0;
      const newTotalCoins = currentCoins + coinsEarned;
      const newTotalClicks = (gameState.userProfile ? gameState.userProfile.total_clicks : 0) + finalClicks;
      const newTotalGames = (gameState.userProfile ? gameState.userProfile.total_games_played : 0) + 1;
      const isNewBest = !gameState.userProfile || finalClicks > gameState.userProfile.best_clicks_per_round;
      const newBestClicks = isNewBest ? finalClicks : (gameState.userProfile ? gameState.userProfile.best_clicks_per_round : 0);

      // ç«‹å³æ›´æ–°é¡¯ç¤ºï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
      if (gameState.userProfile) {
        gameState.userProfile.coins = newTotalCoins;
        gameState.userProfile.total_clicks = newTotalClicks;
        gameState.userProfile.total_games_played = newTotalGames;
        if (isNewBest) {
          gameState.userProfile.best_clicks_per_round = newBestClicks;
        }
        updateProfileDisplay();
      }

      // ç«‹å³é¡¯ç¤ºçµç®—çµæœ
      showGameResultToast(finalClicks, coinsEarned);

      // ç•°æ­¥æäº¤åˆ°å¾Œç«¯ï¼ˆä¸é˜»å¡ UIï¼‰
      (async () => {
        try {
          // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
          const loadingEl = document.getElementById('resultLoading');
          if (loadingEl) {
            loadingEl.style.display = 'block';
          }

          const result = await apiCall('/api/submit-game/', 'POST', {
            clicks: finalClicks,
            game_duration: gameState.gameDuration
          }, false, false);

          // éš±è—è¼‰å…¥ç‹€æ…‹
          if (loadingEl) {
            loadingEl.style.display = 'none';
          }

          // ä½¿ç”¨å¾Œç«¯è¿”å›çš„å¯¦éš›è³‡æ–™æ›´æ–°ï¼ˆå¯èƒ½åŒ…å«æˆå°±çå‹µç­‰ï¼‰
          if (result.profile) {
            gameState.userProfile = result.profile;
            updateProfileDisplay();
          }

          // é¡¯ç¤ºæ–°æˆå°±
          if (result.new_achievements && result.new_achievements.length > 0) {
            showAchievementNotification(result.new_achievements[0]);
            // æ›´æ–°å·²è§£é–æˆå°±ç·©å­˜ï¼Œå„ªåŒ–å¾½ç« é¸æ“‡éŸ¿æ‡‰é€Ÿåº¦
            const newAchievement = result.new_achievements[0];
            if (!gameState.unlockedAchievements.find(a => a.id === newAchievement.id)) {
              gameState.unlockedAchievements.push({
                id: newAchievement.id,
                name: newAchievement.name,
                icon: newAchievement.icon,
              });
            }
          }

          // å„ªåŒ–ï¼šç›´æ¥ä½¿ç”¨è¿”å›çš„æ­·å²è¨˜éŒ„ï¼Œé¿å…å†æ¬¡è«‹æ±‚
          if (result.history) {
            displayHistory(result.history);
          } else {
            // å¦‚æœæ²’æœ‰è¿”å›æ­·å²è¨˜éŒ„ï¼Œæ‰é‡æ–°è¼‰å…¥ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
            loadHistory();
          }
        } catch (error) {
          // éŒ¯èª¤è™•ç†ï¼šå¦‚æœæäº¤å¤±æ•—ï¼Œå›æ»¾æ¨‚è§€æ›´æ–°
          console.error('æäº¤éŠæˆ²çµæœå¤±æ•—:', error);
          // é‡æ–°è¼‰å…¥å¯¦éš›è³‡æ–™
          try {
            await loadProfile();
          } catch (loadError) {
            console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', loadError);
          }
        }
      })();
    }

    // åŠ è¼‰å•†åº—
    async function loadShop() {
      try {
        const result = await apiCall('/api/shop/');
        displayShopItems(result.items);
      } catch (error) {
        // éŒ¯èª¤è™•ç†
      }
    }

    // é¡¯ç¤ºå•†åº—ç‰©å“
    function displayShopItems(items) {
      const container = document.getElementById('shopItemsContainer');
      container.innerHTML = '';

      items.forEach(item => {
        const itemDiv = document.createElement('div');
        const isDisabled = item.requires_extra_button && !item.can_upgrade;
        itemDiv.className = 'shop-item' + (isDisabled ? ' disabled' : '');
        
        let requirementText = '';
        if (item.requires_extra_button && !item.can_upgrade) {
          requirementText = '<div class="shop-item-requirement">âš ï¸ å‰ç½®æ¢ä»¶ï¼šéœ€è¦å…ˆè³¼è²·ã€Œé¡å¤–é»æ“ŠæŒ‰éˆ•ã€</div>';
        }
        
        // åˆ¤æ–·é¡¯ç¤ºæ–‡å­—
        let priceText = '';
        let buttonText = '';
        if (item.can_upgrade) {
          priceText = item.next_level_price + ' ğŸ’°';
          buttonText = 'è³¼è²·';
        } else if (item.is_unpurchased) {
          priceText = 'æœªè³¼è²·';
          buttonText = 'æœªè³¼è²·';
        } else {
          priceText = 'å·²æ»¿ç´š';
          buttonText = 'å·²æ»¿ç´š';
        }
        
        itemDiv.innerHTML = `
          <div class="shop-item-header">
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-level">Lv.${item.current_level}/${item.max_level}</div>
          </div>
          <div class="shop-item-description">${item.description}</div>
          ${requirementText}
          <div class="shop-item-footer">
            <div class="shop-item-price">
              ${priceText}
            </div>
            <button class="btn btn-primary" 
                    onclick="purchaseItem(${item.id})" 
                    ${!item.can_upgrade ? 'disabled' : ''}>
              ${buttonText}
            </button>
          </div>
        `;
        container.appendChild(itemDiv);
      });
    }

    // è³¼è²·ç‰©å“
    async function purchaseItem(itemId) {
      try {
        // ç¢ºä¿ itemId æ˜¯æ•¸å­—ï¼ˆè™•ç†å­—ä¸²æ•¸å­—çš„æƒ…æ³ï¼‰
        const numericItemId = typeof itemId === 'string' ? parseInt(itemId, 10) : itemId;
        if (isNaN(numericItemId) || numericItemId <= 0) {
          showErrorToast('éŒ¯èª¤', 'ç„¡æ•ˆçš„ç‰©å“ID');
          return;
        }
        const result = await apiCall('/api/purchase/', 'POST', { item_id: numericItemId }, false, true);
        if (result.success) {
          await loadProfile();
          await loadShop();
          // é¡¯ç¤ºç¾åŒ–çš„è³¼è²·æˆåŠŸé€šçŸ¥
          showPurchaseToast(result.item_name, result.new_level);
        }
      } catch (error) {
        // éŒ¯èª¤å·²åœ¨ apiCall ä¸­è™•ç†ï¼ˆä½¿ç”¨ Toastï¼‰
      }
    }

    // è³¼è²·é€šçŸ¥éšŠåˆ—
    let purchaseToastQueue = [];
    let purchaseToastTimer = null;
    let isPurchaseToastShowing = false;

    // é¡¯ç¤ºè³¼è²·æˆåŠŸé€šçŸ¥ï¼ˆä½¿ç”¨éšŠåˆ—ç³»çµ±ï¼‰
    function showPurchaseToast(itemName, newLevel) {
      // å°‡é€šçŸ¥åŠ å…¥éšŠåˆ—ï¼ˆåŒ…å«å•†å“åç¨±å’Œç­‰ç´šï¼‰
      purchaseToastQueue.push({ itemName, newLevel });
      
      // å¦‚æœç•¶å‰æ²’æœ‰é€šçŸ¥åœ¨é¡¯ç¤ºï¼Œç«‹å³é¡¯ç¤ºä¸‹ä¸€å€‹
      if (!isPurchaseToastShowing) {
        processPurchaseToastQueue();
      }
    }

    // è™•ç†è³¼è²·é€šçŸ¥éšŠåˆ—
    function processPurchaseToastQueue() {
      // å¦‚æœéšŠåˆ—ç‚ºç©ºï¼Œé‡ç½®ç‹€æ…‹
      if (purchaseToastQueue.length === 0) {
        isPurchaseToastShowing = false;
        return;
      }

      // æ¨™è¨˜ç‚ºæ­£åœ¨é¡¯ç¤º
      isPurchaseToastShowing = true;
      
      // å¾éšŠåˆ—ä¸­å–å‡ºç¬¬ä¸€å€‹é€šçŸ¥
      const notification = purchaseToastQueue.shift();
      const toast = document.getElementById('purchaseToast');
      const messageEl = document.getElementById('purchaseToastMessage');
      
      // è¨­ç½®é€šçŸ¥å…§å®¹ï¼ˆåŒ…å«å•†å“åç¨±å’Œç­‰ç´šï¼‰
      if (notification.itemName && notification.newLevel) {
        messageEl.textContent = `${notification.itemName} å·²å‡ç´šåˆ°ç­‰ç´š ${notification.newLevel}`;
      } else if (notification.itemName) {
        messageEl.textContent = `${notification.itemName} å·²æˆåŠŸè³¼è²·`;
      } else if (notification.newLevel) {
        messageEl.textContent = `å·²å‡ç´šåˆ°ç­‰ç´š ${notification.newLevel}`;
      } else {
        messageEl.textContent = 'ç‰©å“å·²æˆåŠŸè³¼è²·';
      }
      
      // é¡¯ç¤ºé€šçŸ¥
      toast.classList.add('show');
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (purchaseToastTimer) {
        clearTimeout(purchaseToastTimer);
      }
      
      // è¨­ç½®è‡ªå‹•é—œé–‰æ™‚é–“ï¼ˆæ ¹æ“šéšŠåˆ—é•·åº¦èª¿æ•´ï¼Œå¦‚æœæœ‰æ›´å¤šé€šçŸ¥ç­‰å¾…ï¼Œé¡¯ç¤ºæ™‚é–“ç¨çŸ­ï¼‰
      const displayTime = purchaseToastQueue.length > 0 ? 2000 : 3000;
      purchaseToastTimer = setTimeout(() => {
        closePurchaseToast();
        // é—œé–‰å¾Œè™•ç†ä¸‹ä¸€å€‹é€šçŸ¥ï¼ˆå»¶é²ä¸€é»è®“å‹•ç•«å®Œæˆï¼‰
        setTimeout(() => {
          processPurchaseToastQueue();
        }, 400);
      }, displayTime);
    }

    // é—œé–‰è³¼è²·æˆåŠŸé€šçŸ¥
    function closePurchaseToast() {
      const toast = document.getElementById('purchaseToast');
      toast.classList.remove('show');
      
      // æ¸…é™¤å®šæ™‚å™¨
      if (purchaseToastTimer) {
        clearTimeout(purchaseToastTimer);
        purchaseToastTimer = null;
      }
      
      // é‡ç½®é¡¯ç¤ºç‹€æ…‹ï¼Œè®“éšŠåˆ—ç¹¼çºŒè™•ç†
      isPurchaseToastShowing = false;
    }

    // æ‰‹å‹•é—œé–‰ä¸¦è™•ç†ä¸‹ä¸€å€‹é€šçŸ¥
    function closePurchaseToastAndProcessNext() {
      closePurchaseToast();
      // å»¶é²ä¸€é»è®“é—œé–‰å‹•ç•«å®Œæˆï¼Œç„¶å¾Œè™•ç†ä¸‹ä¸€å€‹é€šçŸ¥
      setTimeout(() => {
        processPurchaseToastQueue();
      }, 400);
    }

    // éŒ¯èª¤æç¤º Toast ç›¸é—œå‡½æ•¸
    let errorToastTimer = null;

    // é¡¯ç¤ºéŒ¯èª¤æç¤º Toast
    function showErrorToast(title, errorData) {
      const toast = document.getElementById('errorToast');
      const titleEl = document.getElementById('errorToastTitle');
      const messageEl = document.getElementById('errorToastMessage');
      
      titleEl.textContent = title;
      
      // å¦‚æœæ˜¯é‡‘å¹£ä¸è¶³éŒ¯èª¤ï¼Œé¡¯ç¤ºè©³ç´°è³‡è¨Š
      if (title === 'é‡‘å¹£ä¸è¶³' && typeof errorData === 'object' && errorData.current_coins !== undefined) {
        const currentCoins = errorData.current_coins || 0;
        const requiredCoins = errorData.required_coins || 0;
        const shortage = errorData.shortage || 0;
        messageEl.innerHTML = `
          ç•¶å‰é‡‘å¹£ï¼š<strong>${currentCoins.toLocaleString()} ğŸ’°</strong><br>
          éœ€è¦é‡‘å¹£ï¼š<strong>${requiredCoins.toLocaleString()} ğŸ’°</strong><br>
          é‚„ç¼ºå°‘ï¼š<strong style="color: #ffd700;">${shortage.toLocaleString()} ğŸ’°</strong>
        `;
      } else {
        // å…¶ä»–éŒ¯èª¤ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        messageEl.textContent = typeof errorData === 'string' ? errorData : (errorData.error || 'ç™¼ç”ŸéŒ¯èª¤');
      }
      
      // é¡¯ç¤º Toast
      toast.classList.add('show');
      
      // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
      if (errorToastTimer) {
        clearTimeout(errorToastTimer);
      }
      
      // è‡ªå‹•é—œé–‰ï¼ˆ5ç§’å¾Œï¼‰
      errorToastTimer = setTimeout(() => {
        closeErrorToast();
      }, 5000);
    }

    // é—œé–‰éŒ¯èª¤æç¤º Toast
    function closeErrorToast() {
      const toast = document.getElementById('errorToast');
      toast.classList.remove('show');
      
      if (errorToastTimer) {
        clearTimeout(errorToastTimer);
        errorToastTimer = null;
      }
    }

    // éŠæˆ²çµç®— Toast ç›¸é—œå‡½æ•¸
    let gameResultToastTimer = null;

    // é¡¯ç¤ºéŠæˆ²çµç®— Toast
    function showGameResultToast(clicks, coinsEarned) {
      const toast = document.getElementById('gameResultToast');
      const clicksEl = document.getElementById('resultClicks');
      const coinsEl = document.getElementById('resultCoins');
      
      if (clicksEl) {
        clicksEl.textContent = clicks.toLocaleString();
      }
      if (coinsEl) {
        coinsEl.textContent = `+${coinsEarned.toLocaleString()} ğŸ’°`;
      }
      
      // é¡¯ç¤º Toast
      toast.classList.add('show');
      
      // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
      if (gameResultToastTimer) {
        clearTimeout(gameResultToastTimer);
      }
      
      // è‡ªå‹•é—œé–‰ï¼ˆ8ç§’å¾Œï¼Œçµ¦ç”¨æˆ¶è¶³å¤ æ™‚é–“æŸ¥çœ‹ï¼‰
      gameResultToastTimer = setTimeout(() => {
        closeGameResultToast();
      }, 8000);
    }

    // é—œé–‰éŠæˆ²çµç®— Toast
    function closeGameResultToast() {
      const toast = document.getElementById('gameResultToast');
      toast.classList.remove('show');
      
      if (gameResultToastTimer) {
        clearTimeout(gameResultToastTimer);
        gameResultToastTimer = null;
      }
    }

    // æ‰“é–‹å•†åº—
    function openShop() {
      document.getElementById('shopModal').classList.add('active');
      loadShop();
    }

    // é—œé–‰å•†åº—
    function closeShop() {
      document.getElementById('shopModal').classList.remove('active');
    }

    // åŠ è¼‰æˆå°±
    async function loadAchievements() {
      try {
        const result = await apiCall('/api/achievements/');
        displayAchievements(result.achievements);
        // æ›´æ–°å·²è§£é–æˆå°±ç·©å­˜ï¼Œå„ªåŒ–å¾½ç« é¸æ“‡éŸ¿æ‡‰é€Ÿåº¦
        const unlockedAchievements = result.achievements.filter(a => a.unlocked);
        gameState.unlockedAchievements = unlockedAchievements.map(a => ({
          id: a.id,
          name: a.name,
          icon: a.icon,
        }));
      } catch (error) {
        // éŒ¯èª¤è™•ç†
      }
    }

    // é¡¯ç¤ºæˆå°±
    function displayAchievements(achievements) {
      const container = document.getElementById('achievementsContainer');
      container.innerHTML = '';

      achievements.forEach(achievement => {
        const card = document.createElement('div');
        card.className = 'achievement-card' + (achievement.unlocked ? ' unlocked' : '');
        card.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-name">${achievement.name}</div>
          <div class="achievement-description">${achievement.description}</div>
          ${achievement.reward_coins > 0 ? `<div style="margin-top: 5px; color: #f59e0b;">çå‹µ: ${achievement.reward_coins} ğŸ’°</div>` : ''}
        `;
        container.appendChild(card);
      });
    }

    // æ‰“é–‹æˆå°±
    function openAchievements() {
      document.getElementById('achievementsModal').classList.add('active');
      loadAchievements();
    }

    // é—œé–‰æˆå°±
    function closeAchievements() {
      document.getElementById('achievementsModal').classList.remove('active');
    }

    // é¸æ“‡å¾½ç« æ¬„ä½
    let currentBadgeSlot = null;
    async function selectBadge(slotNumber) {
      currentBadgeSlot = slotNumber;
      
      // å„ªåŒ–ï¼šå…ˆæª¢æŸ¥ç·©å­˜çš„å·²è§£é–æˆå°±åˆ—è¡¨ï¼Œæä¾›å³æ™‚åé¥‹
      const cachedAchievements = gameState.unlockedAchievements || [];
      
      // å¦‚æœç·©å­˜ä¸­æœ‰æˆå°±ï¼Œç«‹å³é¡¯ç¤ºï¼ˆç„¡éœ€ç­‰å¾… APIï¼‰
      if (cachedAchievements.length > 0) {
        displayBadgeSelection(cachedAchievements);
        document.getElementById('badgeSelectModal').classList.add('active');
        return;
      }
      
      // å¦‚æœç·©å­˜ç‚ºç©ºï¼Œå…ˆé¡¯ç¤ºæç¤ºï¼ˆå³æ™‚åé¥‹ï¼‰
      // åŒæ™‚åœ¨èƒŒæ™¯åˆ·æ–°æˆå°±åˆ—è¡¨ï¼ˆä»¥é˜²ç·©å­˜éæœŸï¼‰
      await customAlert('æ‚¨é‚„æ²’æœ‰è§£é–ä»»ä½•æˆå°±ï¼', 'æç¤º', 'â„¹ï¸');
      
      // åœ¨èƒŒæ™¯åˆ·æ–°æˆå°±åˆ—è¡¨ï¼Œæ›´æ–°ç·©å­˜ï¼ˆä¸é˜»å¡ç”¨æˆ¶æ“ä½œï¼‰
      try {
        const result = await apiCall('/api/achievements/', 'GET', null, true); // ä½¿ç”¨éœé»˜æ¨¡å¼
        const unlockedAchievements = result.achievements.filter(a => a.unlocked);
        // ç¢ºä¿ç·©å­˜æ ¼å¼ä¸€è‡´ï¼ˆåªä¿å­˜éœ€è¦çš„æ¬„ä½ï¼‰
        gameState.unlockedAchievements = unlockedAchievements.map(a => ({
          id: a.id,
          name: a.name,
          icon: a.icon,
        }));
      } catch (error) {
        // éœé»˜è™•ç†éŒ¯èª¤ï¼Œä¸å½±éŸ¿ç”¨æˆ¶é«”é©—
        console.error('åˆ·æ–°æˆå°±åˆ—è¡¨å¤±æ•—:', error);
      }
    }

    // é¡¯ç¤ºå¾½ç« é¸æ“‡åˆ—è¡¨
    function displayBadgeSelection(achievements) {
      const container = document.getElementById('badgeSelectContainer');
      container.innerHTML = '';
      
      // æ·»åŠ æˆå°±é¸é …
      achievements.forEach(achievement => {
        const badgeOption = document.createElement('div');
        badgeOption.style.cssText = 'text-align: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s; height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-sizing: border-box;';
        badgeOption.innerHTML = `
          <div style="font-size: 32px; margin-bottom: 5px; line-height: 1; flex-shrink: 0;">${achievement.icon}</div>
          <div style="font-size: 12px; color: #666; word-break: break-word; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.3; max-height: 2.6em;">${achievement.name}</div>
        `;
        badgeOption.onclick = () => {
          updateBadge(currentBadgeSlot, achievement.id);
        };
        badgeOption.onmouseenter = function() {
          this.style.borderColor = '#667eea';
          this.style.background = '#f0f4ff';
        };
        badgeOption.onmouseleave = function() {
          this.style.borderColor = '#e0e0e0';
          this.style.background = 'white';
        };
        container.appendChild(badgeOption);
      });
    }

    // æ›´æ–°å¾½ç« 
    async function updateBadge(slotNumber, achievementId) {
      try {
        const badges = gameState.badges || [null, null, null];
        const badgeIds = badges.map(b => b ? b.id : null);
        badgeIds[slotNumber - 1] = achievementId;
        
        const result = await apiCall('/api/update-badges/', 'POST', {
          badge_1_id: badgeIds[0],
          badge_2_id: badgeIds[1],
          badge_3_id: badgeIds[2],
        });
        
        if (result.success) {
          gameState.badges = result.badges;
          updateBadgesDisplay();
          closeBadgeSelect();
        }
      } catch (error) {
        await customAlert('æ›´æ–°å¾½ç« å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'éŒ¯èª¤', 'âš ï¸');
      }
    }

    // æ¸…é™¤ç•¶å‰æ¬„ä½
    function clearBadgeSlot() {
      if (currentBadgeSlot) {
        updateBadge(currentBadgeSlot, null);
      }
    }

    // é—œé–‰å¾½ç« é¸æ“‡æ¨¡æ…‹æ¡†
    function closeBadgeSelect() {
      document.getElementById('badgeSelectModal').classList.remove('active');
      currentBadgeSlot = null;
    }

    // é¡¯ç¤ºæˆå°±é€šçŸ¥
    function showAchievementNotification(achievement) {
      document.getElementById('notificationIcon').textContent = achievement.icon;
      document.getElementById('notificationTitle').textContent = achievement.name;
      document.getElementById('notificationDescription').textContent = achievement.description;
      if (achievement.reward_coins > 0) {
        document.getElementById('notificationDescription').textContent += `\nç²å¾— ${achievement.reward_coins} é‡‘å¹£ï¼`;
      }
      document.getElementById('achievementNotification').classList.add('active');
    }

    // é—œé–‰æˆå°±é€šçŸ¥
    function closeAchievementNotification() {
      document.getElementById('achievementNotification').classList.remove('active');
    }

    // åˆ‡æ›è¨­å®šä¸‹æ‹‰é¸å–®
    function toggleSettings() {
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    }

    // é—œé–‰è¨­å®šä¸‹æ‹‰é¸å–®
    function closeSettings() {
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.remove('active');
    }

    // æ‰“é–‹å¸³è™Ÿä»‹é¢ï¼ˆåƒ…ç©å®¶è³‡æ–™ï¼‰
    function openAccount() {
      document.getElementById('accountModal').classList.add('active');
      loadAccountInfo();
    }

    // é—œé–‰å¸³è™Ÿä»‹é¢
    function closeAccount() {
      document.getElementById('accountModal').classList.remove('active');
    }

    // æ‰“é–‹æ­·å²è¨˜éŒ„ä»‹é¢
    function openHistory() {
      // å…ˆæ¸…é™¤èˆŠçš„æ­·å²è¨˜éŒ„é¡¯ç¤ºï¼Œé¿å…é¡¯ç¤ºä¸Šä¸€å€‹ç”¨æˆ¶çš„è¨˜éŒ„
      document.getElementById('detailedHistoryContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</p>';
      document.getElementById('historyModal').classList.add('active');
      loadDetailedHistory();
    }

    // é—œé–‰æ­·å²è¨˜éŒ„ä»‹é¢
    function closeHistory() {
      document.getElementById('historyModal').classList.remove('active');
    }

    // åŠ è¼‰å¸³è™Ÿè³‡è¨Š
    function loadAccountInfo() {
      if (!gameState.userProfile) return;
      
      const container = document.getElementById('accountProfileInfo');
      const profile = gameState.userProfile;
      
      // æ ¼å¼åŒ–å‰µç«‹æ—¥æœŸ
      let createdDateStr = 'æœªçŸ¥';
      if (profile.created_at) {
        const createdDate = new Date(profile.created_at);
        createdDateStr = createdDate.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      container.innerHTML = `
        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
          <h4 style="margin-bottom: 15px; color: #667eea;">åŸºæœ¬è³‡æ–™</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>ğŸ‘¤ å¸³è™Ÿåç¨±:</strong> ${profile.username || 'æœªçŸ¥'}
            </div>
            <div>
              <strong>ğŸ“… å‰µç«‹æ—¥æœŸ:</strong> ${createdDateStr}
            </div>
            <div>
              <strong>âš”ï¸ å°æˆ°å‹å ´æ•¸:</strong> ${(profile.battle_wins || 0).toLocaleString()}
            </div>
          </div>
        </div>
        <div>
          <h4 style="margin-bottom: 15px; color: #667eea;">éŠæˆ²çµ±è¨ˆ</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>ğŸ’° é‡‘å¹£:</strong> ${profile.coins.toLocaleString()}
            </div>
            <div>
              <strong>ç¸½é»æ“Šæ•¸:</strong> ${profile.total_clicks.toLocaleString()}
            </div>
            <div>
              <strong>å–®å±€æœ€ä½³:</strong> ${profile.best_clicks_per_round.toLocaleString()}
            </div>
            <div>
              <strong>éŠæˆ²å±€æ•¸:</strong> ${profile.total_games_played.toLocaleString()}
            </div>
          </div>
        </div>
      `;
    }

    // åŠ è¼‰è©³ç´°æ­·å²è¨˜éŒ„ï¼ˆå›ºå®šé¡¯ç¤º20ç­†ï¼‰
    async function loadDetailedHistory() {
      try {
        const result = await apiCall('/api/history/?limit=20');
        displayDetailedHistory(result.history);
      } catch (error) {
        // éŒ¯èª¤è™•ç†
        const container = document.getElementById('detailedHistoryContainer');
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">è¼‰å…¥æ­·å²è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤</p>';
      }
    }

    // é¡¯ç¤ºè©³ç´°æ­·å²è¨˜éŒ„
    function displayDetailedHistory(history) {
      const container = document.getElementById('detailedHistoryContainer');
      if (history.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æš«ç„¡è¨˜éŒ„</p>';
        return;
      }

      let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
      html += '<thead>';
      html += '<tr style="background: #f0f0f0;">';
      html += '<th style="padding: 10px; border-bottom: 2px solid #e0e0e0; text-align: left; white-space: nowrap; min-width: 150px;">æ—¥æœŸæ™‚é–“</th>';
      html += '<th style="padding: 10px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 80px;">é»æ“Šæ•¸</th>';
      html += '<th style="padding: 10px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 100px;">éŠæˆ²æ™‚é•·</th>';
      html += '<th style="padding: 10px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 120px;">ç²å¾—é‡‘å¹£</th>';
      html += '<th style="padding: 10px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 100px;">é»æ“Šç‡</th>';
      html += '</tr>';
      html += '</thead>';
      html += '<tbody>';
      
      history.forEach(session => {
        const date = new Date(session.played_at);
        const dateStr = date.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        const clickRate = session.game_duration > 0 
          ? (session.clicks / session.game_duration).toFixed(2) 
          : '0.00';
        
        html += `<tr style="border-bottom: 1px solid #e0e0e0;">`;
        html += `<td style="padding: 10px; white-space: nowrap;">${dateStr}</td>`;
        html += `<td style="padding: 10px; text-align: center; font-weight: bold; white-space: nowrap;">${session.clicks.toLocaleString()}</td>`;
        html += `<td style="padding: 10px; text-align: center; white-space: nowrap;">${session.game_duration.toFixed(1)} ç§’</td>`;
        html += `<td style="padding: 10px; text-align: center; color: #f59e0b; font-weight: bold; white-space: nowrap;">+${session.coins_earned.toLocaleString()} ğŸ’°</td>`;
        html += `<td style="padding: 10px; text-align: center; white-space: nowrap;">${clickRate} æ¬¡/ç§’</td>`;
        html += `</tr>`;
      });
      
      html += '</tbody>';
      html += '</table>';
      container.innerHTML = html;
    }

    // åŠ è¼‰æ­·å²è¨˜éŒ„
    async function loadHistory() {
      try {
        const result = await apiCall('/api/history/?limit=10');
        displayHistory(result.history);
      } catch (error) {
        // éŒ¯èª¤è™•ç†
      }
    }

    // é¡¯ç¤ºæ­·å²è¨˜éŒ„
    function displayHistory(history) {
      const container = document.getElementById('historyContainer');
      if (history.length === 0) {
        container.innerHTML = '<p style="color: #666;">æš«ç„¡è¨˜éŒ„</p>';
        return;
      }

      let html = '<table style="width: 100%; border-collapse: collapse;">';
      html += '<tr><th style="padding: 8px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 60px;">é»æ“Š</th><th style="padding: 8px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 60px;">æ™‚é•·</th><th style="padding: 8px; border-bottom: 2px solid #e0e0e0; text-align: center; white-space: nowrap; min-width: 80px;">é‡‘å¹£</th></tr>';
      
      history.forEach(session => {
        const date = new Date(session.played_at);
        html += `<tr>
          <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: center; white-space: nowrap;">${session.clicks}</td>
          <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: center; white-space: nowrap;">${session.game_duration.toFixed(1)} ç§’</td>
          <td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: center; white-space: nowrap;">+${session.coins_earned} ğŸ’°</td>
        </tr>`;
      });
      
      html += '</table>';
      container.innerHTML = html;
    }

    // é˜²æ­¢æ‰‹æ©Ÿé€£é»æ”¾å¤§ - æ”¹é€²ç‰ˆï¼šåªé˜»æ­¢çœŸæ­£çš„é›™æ“Šç¸®æ”¾ï¼Œä¸å½±éŸ¿å¿«é€Ÿé€£é»
    let lastTouchEnd = 0;
    let lastTouchPosition = { x: 0, y: 0 };
    document.addEventListener('touchend', function (event) {
      // åªé˜»æ­¢éæŒ‰éˆ•å€åŸŸçš„å¿«é€Ÿé›™æ“Šï¼ˆé˜²æ­¢ç¸®æ”¾ï¼‰
      const target = event.target;
      const isButton = target.tagName === 'BUTTON' || target.closest('button') || target.closest('.click-button');
      
      if (!isButton) {
        const now = Date.now();
        const touch = event.changedTouches[0];
        const currentPos = { x: touch.clientX, y: touch.clientY };
        
        // è¨ˆç®—è·é›¢ï¼ˆåŒä¸€ä½ç½®çš„é›™æ“Šæ‰é˜»æ­¢ï¼‰
        const distance = Math.sqrt(
          Math.pow(currentPos.x - lastTouchPosition.x, 2) + 
          Math.pow(currentPos.y - lastTouchPosition.y, 2)
        );
        
        // åªåœ¨åŒä¸€ä½ç½®ï¼ˆè·é›¢å°æ–¼10pxï¼‰ä¸”æ™‚é–“é–“éš”å°æ–¼300msæ™‚æ‰é˜»æ­¢
        if (now - lastTouchEnd <= 300 && distance < 10) {
          event.preventDefault();
        }
        
        lastTouchPosition = currentPos;
        lastTouchEnd = now;
      }
    }, false);

    // é˜²æ­¢æ‰‹æ©Ÿé€£é»æ”¾å¤§ - é˜»æ­¢æ‰‹å‹¢ç¸®æ”¾
    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gestureend', function (e) {
      e.preventDefault();
    });

    // é˜²æ­¢æ‰‹æ©Ÿç‰ˆä¸‹æ‹‰åˆ·æ–°
    let touchStartY = 0;
    let touchStartX = 0;
    let isScrolling = false;

    document.addEventListener('touchstart', function (e) {
      touchStartY = e.touches[0].clientY;
      touchStartX = e.touches[0].clientX;
      isScrolling = false;
    }, { passive: true });

    document.addEventListener('touchmove', function (e) {
      if (!touchStartY || !touchStartX) return;
      
      const touchY = e.touches[0].clientY;
      const touchX = e.touches[0].clientX;
      const deltaY = touchY - touchStartY;
      const deltaX = touchX - touchStartX;
      
      // åˆ¤æ–·æ˜¯å¦ç‚ºå‚ç›´æ»¾å‹•
      if (Math.abs(deltaY) > Math.abs(deltaX)) {
        isScrolling = true;
        
        // å¦‚æœé é¢å·²ç¶“åœ¨é ‚éƒ¨ä¸”å‘ä¸‹æ»‘å‹•ï¼Œé˜»æ­¢ä¸‹æ‹‰åˆ·æ–°
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop === 0 && deltaY > 0) {
          e.preventDefault();
        }
        // å¦‚æœé é¢å·²ç¶“åœ¨åº•éƒ¨ä¸”å‘ä¸Šæ»‘å‹•ï¼Œä¹Ÿé˜»æ­¢ï¼ˆé˜²æ­¢è§¸ç™¼åˆ·æ–°ï¼‰
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        if (scrollTop + clientHeight >= scrollHeight - 1 && deltaY < 0) {
          e.preventDefault();
        }
      }
    }, { passive: false });

    document.addEventListener('touchend', function (e) {
      touchStartY = 0;
      touchStartX = 0;
      isScrolling = false;
    }, { passive: true });

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // å›è»Šéµç™»éŒ„
      document.getElementById('usernameInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loginOrRegister();
        }
      });

      // ç‚ºæ‰€æœ‰æŒ‰éˆ•æ·»åŠ  touch-action é˜²æ­¢ç¸®æ”¾ï¼Œä½†ä¸é˜»æ­¢å¿«é€Ÿé€£é»
      const buttons = document.querySelectorAll('button, .click-button');
      buttons.forEach(button => {
        button.style.touchAction = 'manipulation';
        // ä¸é˜»æ­¢æŒ‰éˆ•çš„å¿«é€Ÿé€£é»ï¼Œåªè¨­ç½® touch-action å³å¯
      });

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      document.getElementById('shopModal').addEventListener('click', (e) => {
        if (e.target.id === 'shopModal') {
          closeShop();
        }
      });

      document.getElementById('achievementsModal').addEventListener('click', (e) => {
        if (e.target.id === 'achievementsModal') {
          closeAchievements();
        }
      });

      // å¾½ç« é¸æ“‡æ¨¡æ…‹æ¡†é»æ“Šå¤–éƒ¨é—œé–‰
      document.getElementById('badgeSelectModal').addEventListener('click', (e) => {
        if (e.target.id === 'badgeSelectModal') {
          closeBadgeSelect();
        }
      });

      document.getElementById('accountModal').addEventListener('click', (e) => {
        if (e.target.id === 'accountModal') {
          closeAccount();
        }
      });

      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target.id === 'historyModal') {
          closeHistory();
        }
      });

      // é»æ“Šå¤–éƒ¨é—œé–‰è¨­å®šä¸‹æ‹‰é¸å–®
      document.addEventListener('click', (e) => {
        const settingsContainer = document.querySelector('.settings-container');
        const settingsDropdown = document.getElementById('settingsDropdown');
        if (settingsContainer && settingsDropdown && 
            !settingsContainer.contains(e.target) && 
            settingsDropdown.classList.contains('active')) {
          closeSettings();
        }
      });

      // å˜—è©¦åŠ è¼‰å·²æœ‰è³‡æ–™ï¼ˆç«‹å³åŸ·è¡Œï¼Œä¸ç­‰å¾…ï¼‰
      loadProfile();
    });
  </script>
</body>
</html>
